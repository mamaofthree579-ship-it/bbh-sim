<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BBH Simulator ‚Äî Overview, Events & Calculators</title>
<style>
  :root{
    --bg1: #04030b;
    --bg2: #081027;
    --panel: rgba(24,6,40,0.7);
    --accent: #8a44ff;
    --muted: #331a44;
    --text: #e7e0ff;
    --glass: rgba(255,255,255,0.03);
  }
  html,body { height:100%; margin:0; font-family:Inter,Arial,Helvetica,sans-serif; background: radial-gradient(circle at 10% 20%, var(--bg2) 0%, var(--bg1) 60%); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .tabs { display:flex; gap:0; max-width:1200px; margin:12px auto 0; background:var(--panel); border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,0.03); }
  .tabButton { flex:1; padding:12px 14px; cursor:pointer; border:0; background:transparent; color:var(--text); font-weight:700; text-align:center; }
  .tabButton:hover { background: rgba(255,255,255,0.02); }
  .tabButton.active { background: linear-gradient(90deg, rgba(138,68,255,0.18), rgba(80,0,128,0.12)); box-shadow: inset 0 -4px 12px rgba(0,0,0,0.4); }
  .container { max-width:1200px; margin:18px auto; padding:0 16px 40px; }
  .panel { background:var(--panel); border-radius:10px; padding:12px; margin-top:12px; border:1px solid rgba(255,255,255,0.03); }
  h2 { margin:6px 0 10px; color:var(--text); }
  canvas { display:block; margin:12px auto; border-radius:10px; background: radial-gradient(circle at center, rgba(20,6,40,0.45), rgba(2,2,8,0.6)); box-shadow: 0 8px 24px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02); }
  label,input,select,button { margin:6px 6px 6px 0; font-size:0.95rem; color:var(--text); }
  input, select { padding:8px; border-radius:6px; background:var(--glass); border:1px solid rgba(255,255,255,0.02); color:var(--text); }
  input[type=range] { width:180px; vertical-align:middle; }
  button { background:var(--accent); color:white; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
  button.secondary { background:#444; color:#ddd; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .muted { color:#cfc8ff; font-size:0.9rem; }
  .legend { display:flex; gap:12px; justify-content:center; margin-top:10px; }
  .sw { width:16px; height:10px; border-radius:4px; display:inline-block; margin-right:8px; border:1px solid rgba(255,255,255,0.04); vertical-align:middle; }
  .tooltip { position: absolute; background: rgba(10,6,20,0.95); color:#fff; padding:10px; border-radius:8px; border:1px solid rgba(120,90,200,0.22); display:none; z-index:1000; max-width:380px; font-size:0.95rem; }
  .tooltip .close { float:right; cursor:pointer; color:#ffd; margin-left:8px; font-weight:bold; }
  .grid { display:grid; grid-template-columns: 1fr 360px; gap:12px; align-items:start; }
  @media (max-width:980px){ .grid{ grid-template-columns: 1fr; } .tabButton{ padding:10px } canvas{ width:100% !important; height:auto !important; } }
  #resultBox { background: rgba(20,10,30,0.85); padding:10px; border-radius:8px; border:1px solid rgba(200,160,255,0.06); color: #ffefe6; opacity:0; transform: translateY(6px); transition: opacity .8s ease, transform .5s ease; }
  #resultBox.visible { opacity:1; transform: translateY(0); }
  pre { background:#070018; padding:8px; border-radius:6px; overflow:auto; color:#f0f0ff; font-size:0.9rem; }
  .small { font-size:0.9rem; color:#d6c7ff; }
  .cw { white-space:nowrap; }
</style>
</head>
<body>

<!-- Tabs -->
<div class="tabs" role="tablist" aria-label="Main tabs">
  <button class="tabButton active" data-tab="overviewTab" role="tab">Overview</button>
  <button class="tabButton" data-tab="eventsTab" role="tab">Events</button>
  <button class="tabButton" data-tab="calcTab" role="tab">Calculators</button>
</div>

<div class="container">

  <!-- OVERVIEW -->
  <section id="overviewTab" class="panel tabContent" style="display:block;">
    <h2>üåå Black Hole Overview</h2>
    <p class="small">A rotating black hole with a glowing accretion disk and twinkling starfield. Click a legend swatch for the explanation and link to the derivation in the calculators tab.</p>

    <canvas id="bhCanvas" width="1080" height="420"></canvas>

    <div class="legend" aria-hidden="true">
      <div class="cw"><span class="sw" style="background:rgba(140,80,255,0.45)"></span>Event Horizon</div>
      <div class="cw"><span class="sw" style="background:rgba(255,170,80,0.22)"></span>Accretion Disk</div>
      <div class="cw"><span class="sw" style="background:rgba(80,200,255,0.18)"></span>Jet / Wind</div>
    </div>
  </section>

  <!-- EVENTS -->
  <section id="eventsTab" class="panel tabContent" style="display:none;">
    <h2>üí´ Gravitational-Wave Events</h2>

    <div class="row" style="margin-bottom:6px;">
      <label for="eventSelect">Event</label>
      <select id="eventSelect"></select>

      <button id="loadMoreBtn" class="secondary">Load More Events</button>
      <button id="runCustomBtn">Run Custom</button>
      <button id="resetBtn" class="secondary">Reset</button>

      <div style="margin-left:auto" class="muted">Audio: <span id="audioState">idle</span></div>
    </div>

    <div class="row" style="margin-bottom:6px;">
      <label>M‚ÇÅ (M‚òâ)</label><input id="m1Input" type="number" value="30" step="0.1" min="1">
      <label>M‚ÇÇ (M‚òâ)</label><input id="m2Input" type="number" value="30" step="0.1" min="1">
      <label>Spin a*</label><input id="spinInput" type="range" min="0" max="1" step="0.01" value="0.50"><span id="spinVal" class="muted">0.50</span>
    </div>

    <div class="grid">
      <div>
        <canvas id="orbitCanvas" width="720" height="380"></canvas>

        <div style="margin-top:10px;">
          <canvas id="chirpCanvas" width="920" height="180"></canvas>
          <div class="row" style="margin-top:8px;">
            <button id="playChirpBtn">üîä Play Chirp</button>
            <button id="stopChirpBtn" class="secondary">‚èπ Stop</button>
            <button id="exportBtn" class="secondary" title="Export JSON">‚¨á Export JSON</button>
            <span class="muted">Playhead shown on chirp</span>
          </div>
        </div>
      </div>

      <aside style="width:360px;">
        <div style="background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); padding:10px; border-radius:8px;">
          <strong>Event Info</strong>
          <p id="eventDescription" class="small muted">‚Äî</p>
          <table style="width:100%;margin-top:8px;color:var(--text)">
            <tr><td class="small muted">Chirp mass</td><td id="chirpMass" style="text-align:right">‚Äî</td></tr>
            <tr><td class="small muted">Freq range</td><td id="freqRange" style="text-align:right">‚Äî</td></tr>
            <tr><td class="small muted">Estimated h</td><td id="gwStrain" style="text-align:right">‚Äî</td></tr>
            <tr><td class="small muted">Distance</td><td id="distance" style="text-align:right">‚Äî</td></tr>
          </table>
        </div>

        <div style="margin-top:12px; padding:10px; border-radius:8px; background:var(--glass); border:1px solid rgba(255,255,255,0.02);">
          <strong class="small">Scientific Summary</strong>
          <h4 class="small muted" style="margin-top:8px">Chirp Amplitude</h4>
          <canvas id="amplitudeCanvas" width="320" height="110"></canvas>
          <h4 class="small muted" style="margin-top:8px">Energy Loss</h4>
          <canvas id="energyCanvas" width="320" height="110"></canvas>
          <h4 class="small muted" style="margin-top:8px">Frequency evolution</h4>
          <canvas id="freqCanvas" width="320" height="110"></canvas>
        </div>
      </aside>
    </div>
  </section>

  <!-- CALCULATORS -->
  <section id="calcTab" class="panel tabContent" style="display:none;">
    <h2>üßÆ Calculators & Simulators</h2>
    <p class="small">Time-dilation near Sgr A*, dark-matter-modified decay rates, PBH profiles and quick phenomenological knobs.</p>

    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
      <label>Distance r (m)</label>
      <input id="rInput" type="number" value="7.8e17" step="1e15" style="width:220px;">
      <label>œÅ<sub>DM</sub> (kg/m¬≥)</label>
      <input id="rhoInput" type="number" value="1e-22" step="1e-23" style="width:220px;">
      <label class="muted">Quantum corr.</label>
      <input id="quantumToggle" type="checkbox">
      <button id="runCalcBtn">‚ñ∂ Run Simulation</button>
    </div>

    <canvas id="calcCanvas" width="920" height="220"></canvas>
    <div id="resultBox"></div>
  </section>

</div>

<!-- Tooltip container -->
<div id="tooltip" class="tooltip" role="dialog" aria-hidden="true">
  <span class="close" id="tooltipClose">√ó</span>
  <div id="tooltipContent"></div>
</div>

<script>
/* ==========================
   Tab switching
   ========================== */
const tabButtons = document.querySelectorAll('.tabButton');
const tabContents = document.querySelectorAll('.tabContent');
tabButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    tabContents.forEach(c => c.style.display = 'none');
    document.getElementById(btn.dataset.tab).style.display = 'block';
    // hide tooltip
    tooltip.style.display = 'none';
  });
});

/* ==========================
   Overview: BH visual + stars
   ========================== */
const bhCanvas = document.getElementById('bhCanvas');
const bhCtx = bhCanvas.getContext('2d');
const bw = bhCanvas.width, bh = bhCanvas.height;
const bhCx = bw/2, bhCy = bh/2, horizonR = 72;
const stars = Array.from({length:170}, ()=>({
  x: Math.random()*bw,
  y: Math.random()*bh,
  r: 0.5 + Math.random()*1.5,
  tw: Math.random()*Math.PI*2,
  vx: (Math.random()-0.5)*0.25
}));
let hotspot = 0;
function drawOverview(){
  bhCtx.clearRect(0,0,bw,bh);
  // background subtle gradient
  const g = bhCtx.createLinearGradient(0,0,0,bh);
  g.addColorStop(0,'rgba(10,6,20,0.5)');
  g.addColorStop(1,'rgba(2,2,8,0.95)');
  bhCtx.fillStyle = g; bhCtx.fillRect(0,0,bw,bh);

  // twinkling stars ‚Äî masked so none are inside horizon
  for(const s of stars){
    s.tw += 0.03 + Math.random()*0.02;
    s.x += s.vx; if(s.x < -5) s.x = bw + 5; if(s.x > bw+5) s.x = -5;
    const d = Math.hypot(s.x - bhCx, s.y - bhCy);
    if(d > horizonR + 12){
      bhCtx.beginPath();
      bhCtx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      bhCtx.fillStyle = `rgba(255,255,255,${0.45 + 0.45*Math.sin(s.tw)})`;
      bhCtx.fill();
    }
  }

  // accretion disk rings
  for(let i=0;i<48;i++){
    bhCtx.beginPath();
    bhCtx.arc(bhCx, bhCy, horizonR + 8 + i*3.2, 0, Math.PI*2);
    bhCtx.strokeStyle = `rgba(255,160,80,${0.006 + i*0.0008})`;
    bhCtx.lineWidth = 1;
    bhCtx.stroke();
  }

  // event-horizon outline (violet)
  bhCtx.beginPath();
  bhCtx.arc(bhCx, bhCy, horizonR, 0, Math.PI*2);
  bhCtx.strokeStyle = 'rgba(140,80,255,0.45)';
  bhCtx.lineWidth = 2.4;
  bhCtx.stroke();

  // jet
  bhCtx.fillStyle = 'rgba(80,200,255,0.04)';
  bhCtx.fillRect(bhCx-8, 0, 16, bhCy - 140);

  // horizon fill (black)
  bhCtx.beginPath();
  bhCtx.arc(bhCx, bhCy, horizonR-2, 0, Math.PI*2);
  bhCtx.fillStyle = 'black'; bhCtx.fill();

  // hotspot orbiting just outside disk
  const hx = bhCx + Math.cos(hotspot) * 110;
  const hy = bhCy + Math.sin(hotspot) * 36;
  bhCtx.beginPath(); bhCtx.arc(hx, hy, 6, 0, Math.PI*2);
  bhCtx.fillStyle = '#ffd9b3';
  bhCtx.fill();

  hotspot += 0.022;
  requestAnimationFrame(drawOverview);
}
drawOverview();

/* ==========================
   Tooltip (Overview legend items)
   ========================== */
const tooltip = document.getElementById('tooltip');
const tooltipContent = document.getElementById('tooltipContent');
const tooltipClose = document.getElementById('tooltipClose');
document.querySelectorAll('.legend .sw').forEach((el, idx)=>{
  // Attach to parent legend item
  el.parentElement.addEventListener('click', (ev)=>{
    const key = idx===0 ? 'Event horizon' : idx===1 ? 'Accretion disk' : 'Relativistic jet';
    tooltipContent.innerHTML = `<strong>${key}</strong><br><small class="muted">Click "Calculators" tab for derivations.</small>`;
    const rect = ev.currentTarget.getBoundingClientRect();
    tooltip.style.left = (rect.left + rect.width/2 - 160) + 'px';
    tooltip.style.top = (rect.top - 120) + 'px';
    tooltip.style.display = 'block';
    tooltip.setAttribute('aria-hidden','false');
  });
});
tooltipClose.addEventListener('click', ()=>{ tooltip.style.display='none'; tooltip.setAttribute('aria-hidden','true'); });

/* ==========================
   EVENTS: data, orbit, waveform, audio
   ========================== */
const eventSelect = document.getElementById('eventSelect');
let events = {
  "GW150914": { m1:36, m2:29, spin:0.34, color:'#ff66cc', desc:"GW150914 ‚Äî first detection (2015): 36 + 29 M‚òâ" },
  "GW170104": { m1:31, m2:19, spin:0.45, color:'#66ccff', desc:"GW170104 ‚Äî 31 + 19 M‚òâ (2017)" },
  "GW170608": { m1:12, m2:7, spin:0.25, color:'#66ff99', desc:"GW170608 ‚Äî 12 + 7 M‚òâ (lighter)" },
  "GW190521": { m1:85, m2:66, spin:0.72, color:'#ff9933', desc:"GW190521 ‚Äî very massive (85 + 66 M‚òâ)" },
  "GW190814": { m1:23, m2:2.6, spin:0.05, color:'#ffd166', desc:"GW190814 ‚Äî asymmetric (BH + compact object)" }
};
function refreshEventOptions(){
  eventSelect.innerHTML='';
  for(const k in events){
    const o = document.createElement('option');
    o.value = k; o.textContent = k; eventSelect.appendChild(o);
  }
}
refreshEventOptions();

document.getElementById('loadMoreBtn').addEventListener('click', ()=>{
  // append a few more well-known events (demo)
  const add = {
    "GW200115": { m1:6, m2:1.5, spin:0.2, color:'#33aaff', desc:"GW200115 ‚Äî NS‚ÄìBH candidate" },
    "GW151226": { m1:14, m2:7.5, spin:0.15, color:'#b266ff', desc:"GW151226 ‚Äî lower-mass BH binary" }
  };
  events = {...events, ...add};
  refreshEventOptions();
});

/* Orbit drawing */
const orbitCanvas = document.getElementById('orbitCanvas');
const ox = orbitCanvas.getContext('2d');
const orbitW = orbitCanvas.width, orbitH = orbitCanvas.height;
let orbitAngle = 0;
let trailsA = [], trailsB = [];
const TRAIL_MAX = 210;
let orbitAnim = null;

function startOrbit(m1,m2,spin,accent){
  if(orbitAnim) cancelAnimationFrame(orbitAnim);
  trailsA = []; trailsB = []; orbitAngle = 0;
  function frame(){
    ox.clearRect(0,0,orbitW,orbitH);
    // background gradient
    const gg = ox.createRadialGradient(orbitW/2, orbitH/2, 20, orbitW/2, orbitH/2, 500);
    gg.addColorStop(0,'rgba(8,4,18,0.6)'); gg.addColorStop(1,'rgba(0,0,0,1)');
    ox.fillStyle = gg; ox.fillRect(0,0,orbitW,orbitH);

    const cx = orbitW/2, cy = orbitH/2;
    const rA = Math.max(60, 38 + (40 * (m2/(m1+m2)))); // scaled radii for aesthetic
    const rB = Math.max(110, rA*1.9);

    const xA = cx + Math.cos(orbitAngle) * rA, yA = cy + Math.sin(orbitAngle) * (rA*0.55);
    const xB = cx - Math.cos(orbitAngle) * rB, yB = cy - Math.sin(orbitAngle) * (rB*0.55);

    trailsA.push({x:xA,y:yA}); trailsB.push({x:xB,y:yB});
    if(trailsA.length>TRAIL_MAX) trailsA.shift(); if(trailsB.length>TRAIL_MAX) trailsB.shift();

    // draw trails (fading)
    for(let i=0;i<trailsA.length;i++){
      const a = i / trailsA.length;
      ox.fillStyle = hexToRgba(accent, 0.12 * a + 0.02);
      ox.fillRect(trailsA[i].x-1.5, trailsA[i].y-1.5, 3, 3);
    }
    for(let i=0;i<trailsB.length;i++){
      const a = i / trailsB.length;
      ox.fillStyle = hexToRgba(shadeColor(accent,-18), 0.14 * a + 0.02);
      ox.fillRect(trailsB[i].x-1.8, trailsB[i].y-1.8, 4, 4);
    }

    // draw bodies
    ox.beginPath(); ox.arc(xA,yA,10,0,Math.PI*2); ox.fillStyle = accent; ox.fill();
    ox.beginPath(); ox.arc(xB,yB,16,0,Math.PI*2); ox.fillStyle = shadeColor(accent,-16); ox.fill();

    // small hotspot / ISCO marker for body A
    ox.beginPath(); ox.arc(cx + Math.cos(orbitAngle*1.28 + spin) * (rA*1.02), cy + Math.sin(orbitAngle*1.28 + spin)*(rA*0.55), 4, 0, Math.PI*2);
    ox.fillStyle = 'rgba(255,220,180,0.85)'; ox.fill();

    orbitAngle += 0.016 + spin*0.012;
    orbitAnim = requestAnimationFrame(frame);
  }
  frame();
}

/* Chirp waveform / audio */
const chirpCanvas = document.getElementById('chirpCanvas');
const cctx = chirpCanvas.getContext('2d');
const waveform = new Float32Array(1600);
let audioCtx = null, osc=null, oscHarm=null, gain=null, gainHarm=null;
let playStart = 0, playDur = 0, playRAF = null;
let currentAccent = '#ff66cc';

function generateWaveformSamples(m1,m2,spin){
  const N = waveform.length;
  // chirp mass (geometrical scale only for shaping)
  const Mc = Math.pow((m1*m2)**(3/5)/(m1+m2)**(1/5),1);
  const f0 = 20 + spin*12;                  // start freq (Hz)
  const f1 = 350 + (Mc/30)*220;             // end freq (Hz) scaled by Mc
  for(let i=0;i<N;i++){
    const t = i / N;
    const env = Math.pow(t,2) * Math.exp(-1.2*(1-t));
    const freq = f0 + Math.pow(t,1.6) * (f1 - f0);
    // time scaling factor to make audible (we only use audio for demo)
    waveform[i] = env * Math.sin(2*Math.PI * freq * (t*1.2));
  }
  currentAccent = events[eventSelect.value]?.color || currentAccent;
  drawChirp(-1);
}

function drawChirp(playIdx=-1){
  const W = chirpCanvas.width, H = chirpCanvas.height;
  cctx.clearRect(0,0,W,H);
  cctx.beginPath();
  for(let i=0;i<waveform.length;i++){
    const x = i/waveform.length * W;
    const y = H/2 - waveform[i] * (H/2) * 0.9;
    if(i===0) cctx.moveTo(x,y); else cctx.lineTo(x,y);
  }
  cctx.strokeStyle = currentAccent; cctx.lineWidth = 2; cctx.stroke();

  if(playIdx>=0){
    const px = playIdx / waveform.length * W;
    cctx.beginPath(); cctx.moveTo(px,0); cctx.lineTo(px,H);
    cctx.strokeStyle = 'rgba(255,60,60,0.9)'; cctx.lineWidth = 1.6; cctx.stroke();
  }
}

async function playChirpAudio(m1,m2,spin,accent){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') await audioCtx.resume().catch(()=>{});
  stopChirpAudio();

  const Mc = Math.pow((m1*m2)**(3/5)/(m1+m2)**(1/5),1);
  const fStart = Math.max(18, 18 + spin*8);
  const fEnd = 420 + (Mc/30)*200;
  const duration = Math.max(0.8, 3.4 - (Mc/35)); // seconds

  // main oscillator + harmonic to improve audibility
  osc = audioCtx.createOscillator(); gain = audioCtx.createGain();
  osc.type = 'sine'; osc.connect(gain); gain.connect(audioCtx.destination);
  oscHarm = audioCtx.createOscillator(); gainHarm = audioCtx.createGain();
  oscHarm.type = 'sine'; oscHarm.connect(gainHarm); gainHarm.connect(audioCtx.destination);

  const now = audioCtx.currentTime;
  osc.frequency.setValueAtTime(fStart, now);
  osc.frequency.exponentialRampToValueAtTime(Math.max(fEnd, fStart+1), now + duration);
  oscHarm.frequency.setValueAtTime(Math.max(2*fStart,2), now);
  oscHarm.frequency.exponentialRampToValueAtTime(Math.max(2*fEnd, 2*fStart+2), now + duration);

  // gains
  gain.gain.setValueAtTime(0.0001, now);
  gain.gain.linearRampToValueAtTime(0.28, now + 0.03);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  gainHarm.gain.setValueAtTime(0.0001, now);
  gainHarm.gain.linearRampToValueAtTime(0.06, now + 0.03);
  gainHarm.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  osc.start(now); osc.stop(now + duration + 0.05);
  oscHarm.start(now); oscHarm.stop(now + duration + 0.05);

  // start visual sync
  playStart = performance.now();
  playDur = duration * 1000;
  document.getElementById('audioState').textContent = 'playing';
  animatePlayheadAndGraphs(accent);
}

function stopChirpAudio(){
  try{ if(osc) osc.stop(); }catch(e){}
  try{ if(oscHarm) oscHarm.stop(); }catch(e){}
  try{ if(gain) gain.disconnect(); }catch(e){}
  try{ if(gainHarm) gainHarm.disconnect(); }catch(e){}
  try{ if(osc) osc.disconnect(); }catch(e){}
  try{ if(oscHarm) oscHarm.disconnect(); }catch(e){}
  osc = oscHarm = gain = gainHarm = null;
  document.getElementById('audioState').textContent = 'idle';
  if(playRAF){ cancelAnimationFrame(playRAF); playRAF = null; drawChirp(-1); drawSummaryGraphs(currentAccent, 0); }
}

/* Visual & graphs sync */
let playRAF = null;
function animatePlayheadAndGraphs(accent){
  const start = playStart;
  function step(){
    const now = performance.now();
    const elapsed = now - start;
    if(elapsed >= playDur){ stopChirpAudio(); return; }
    const prog = elapsed / playDur;
    const idx = Math.floor(prog * waveform.length);
    drawChirp(idx);
    drawPulseOverlay(prog, accent);
    drawSummaryGraphs(accent, prog);
    playRAF = requestAnimationFrame(step);
  }
  step();
}

function drawPulseOverlay(progress, accent){
  const W = chirpCanvas.width, H = chirpCanvas.height;
  const centerX = progress * W;
  const width = Math.max(8, 0.06 * W * (0.3 + progress));
  const g = cctx.createLinearGradient(centerX-width,0,centerX+width,0);
  g.addColorStop(0, 'rgba(0,0,0,0)');
  g.addColorStop(0.35, hexToRgba(accent,0.22));
  g.addColorStop(0.65, hexToRgba(accent,0.22));
  g.addColorStop(1, 'rgba(0,0,0,0)');
  cctx.fillStyle = g; cctx.fillRect(centerX-width, 0, width*2, H);
}

/* Summary graphs (small) */
function drawSummaryGraphs(accent, progress=0){
  const ampCtx = document.getElementById('amplitudeCanvas').getContext('2d');
  const engCtx = document.getElementById('energyCanvas').getContext('2d');
  const fqCtx  = document.getElementById('freqCanvas').getContext('2d');
  drawGraphAnim(ampCtx, accent, t => Math.pow(t*(0.3+0.7*progress+0.5), 3) * Math.sin(30*t*Math.PI), progress);
  drawGraphAnim(engCtx, accent, t => Math.pow(t*(0.2+0.8*progress+0.4), 2.5) * Math.exp(-3*t*(1 - 0.4*(1-progress))), progress);
  drawGraphAnim(fqCtx,  accent, t => Math.pow(t*(0.6+0.4*progress+0.2), 1.6), progress);
}
function drawGraphAnim(ctx, color, fn, progress){
  const W = ctx.canvas.width, H = ctx.canvas.height;
  ctx.clearRect(0,0,W,H); ctx.beginPath();
  for(let i=0;i<W;i++){
    const t = i / W;
    const y = H/2 - fn(t) * H/3;
    if(i===0) ctx.moveTo(i,y); else ctx.lineTo(i,y);
  }
  ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
}

/* ========== Utilities ========== */
function hexToRgba(hex, alpha=1.0){
  if(!hex) return `rgba(200,200,200,${alpha})`;
  if(hex.startsWith('rgba') || hex.startsWith('rgb')) {
    const nums = hex.replace(/rgba?|\(|\)|\s/g,'').split(',').map(Number);
    return `rgba(${nums[0]},${nums[1]},${nums[2]},${alpha})`;
  }
  const h = hex.replace('#','');
  const r = parseInt(h.substring(0,2),16), g = parseInt(h.substring(2,4),16), b = parseInt(h.substring(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function shadeColor(hex, percent){
  if(!hex.startsWith('#')) return hex;
  const h = hex.replace('#','');
  const r = clamp(parseInt(h.substring(0,2),16) + Math.round(2.55*percent),0,255);
  const g = clamp(parseInt(h.substring(2,4),16) + Math.round(2.55*percent),0,255);
  const b = clamp(parseInt(h.substring(4,6),16) + Math.round(2.55*percent),0,255);
  return `rgb(${r},${g},${b})`;
}
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }

/* ========== Event wiring ========== */
const spinInput = document.getElementById('spinInput');
const spinVal = document.getElementById('spinVal');
spinVal.textContent = Number(spinInput.value).toFixed(2);
spinInput.addEventListener('input', ()=>{ spinVal.textContent = Number(spinInput.value).toFixed(2); });

function updateSummaryFields(m1,m2){
  const chirpMass = Math.pow((m1*m2)**(3/5)/(m1+m2)**(1/5),1);
  document.getElementById('chirpMass').textContent = chirpMass.toFixed(2) + " M‚òâ";
  document.getElementById('freqRange').textContent = "20‚Äì400 Hz";
  document.getElementById('gwStrain').textContent = (4e-21 * Math.pow(chirpMass/30,5/3)).toExponential(2);
  document.getElementById('distance').textContent = `${(chirpMass*40).toFixed(0)} million ly`;
}

function loadEvent(key){
  const ev = events[key];
  if(!ev) return;
  eventSelect.value = key;
  document.getElementById('m1Input').value = ev.m1;
  document.getElementById('m2Input').value = ev.m2;
  spinInput.value = ev.spin; spinVal.textContent = Number(ev.spin).toFixed(2);
  document.getElementById('eventDescription').textContent = ev.desc;
  currentAccent = ev.color;
  generateWaveformSamples(ev.m1, ev.m2, ev.spin);
  drawSummaryGraphs(ev.color, 0);
  startOrbit(ev.m1, ev.m2, ev.spin, ev.color);
  updateSummaryFields(ev.m1, ev.m2);
}

eventSelect.addEventListener('change', ()=> loadEvent(eventSelect.value));
document.getElementById('runCustomBtn').addEventListener('click', ()=>{
  const m1 = clamp(parseFloat(document.getElementById('m1Input').value) || 30, 1, 1e6);
  const m2 = clamp(parseFloat(document.getElementById('m2Input').value) || 30, 1, 1e6);
  const spin = clamp(parseFloat(spinInput.value) || 0.5, 0, 1);
  events['Custom'] = { m1, m2, spin, color:'#a64dff', desc: `Custom: ${m1} + ${m2} M‚òâ, spin ${spin}` };
  refreshEventOptions();
  loadEvent('Custom');
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  const key = eventSelect.value || Object.keys(events)[0];
  loadEvent(key);
  stopChirpAudio();
});

/* play/stop chirp */
document.getElementById('playChirpBtn').addEventListener('click', async ()=>{
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') await audioCtx.resume().catch(()=>{});
  const ev = events[eventSelect.value] || events['Custom'];
  generateWaveformSamples(ev.m1, ev.m2, ev.spin);
  playChirpAudio(ev.m1, ev.m2, ev.spin, ev.color);
});
document.getElementById('stopChirpBtn').addEventListener('click', ()=> stopChirpAudio());

/* export json */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const ev = events[eventSelect.value] || events['Custom'];
  const params = { simulation_name:eventSelect.value, m1:ev.m1, m2:ev.m2, spin:ev.spin, color:ev.color, timestamp: new Date().toISOString() };
  const samples = Array.from(waveform).map(v => Math.round(v*1e6)/1e6);
  const payload = { params, samples, notes:"Mock waveform (for demo only)" };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${eventSelect.value}_waveform.json`; a.click();
  URL.revokeObjectURL(url);
});

/* ensure audio resumes on first user gesture (some browsers require) */
['click','keydown','pointerdown','touchstart'].forEach(ev => {
  window.addEventListener(ev, ()=> {
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  }, { once:true });
});

/* initial load */
refreshEventOptions();
loadEvent(Object.keys(events)[0]);

/* ==========================
   CALCULATOR tab (Sgr A*, DM, decay)
   ========================== */
const calcCtx = document.getElementById('calcCanvas').getContext('2d');
function runCalc(){
  const G = 6.67430e-11, c = 3e8;
  const M = 4.3e6 * 1.989e30; // Sgr A* mass
  const r = clamp(parseFloat(document.getElementById('rInput').value) || 7.8e17, 1e6, 1e22);
  const rho = clamp(parseFloat(document.getElementById('rhoInput').value) || 1e-22, 0, 1e-10);
  const quantum = document.getElementById('quantumToggle').checked;
  const gammaTime = Math.sqrt(Math.max(0, 1 - (2*G*M)/(r*c*c)));
  const alpha = 1e20; // phenomenological coefficient (example)
  const gammaDark = 1 + alpha * rho;
  let gammaEff = gammaTime * gammaDark;
  if(quantum) gammaEff *= 1.05;

  // draw small waveform to visualize gammaEff
  calcCtx.clearRect(0,0,calcCanvas.width,calcCanvas.height);
  calcCtx.beginPath();
  for(let i=0;i<calcCanvas.width;i++){
    const t = i / calcCanvas.width;
    const y = calcCanvas.height/2 - Math.sin(t*10*Math.PI)*(20 + 30*(1 - Math.exp(-gammaEff)));
    if(i===0) calcCtx.moveTo(i,y); else calcCtx.lineTo(i,y);
  }
  calcCtx.strokeStyle = '#a64dff'; calcCtx.lineWidth = 2; calcCtx.stroke();

  // results
  const decayRate = (1 / gammaEff);
  const rb = document.getElementById('resultBox');
  rb.innerHTML = `<strong>Results</strong><br>
    <span class="small muted">Time dilation (Œ≥<sub>t</sub>)</span> <br><code>${gammaTime.toFixed(6)}</code><br>
    <span class="small muted">Dark-matter factor (1 + Œ±¬∑œÅ)</span> <br><code>${gammaDark.toFixed(6)}</code><br>
    <span class="small muted">Effective multiplier (Œ≥<sub>eff</sub>)</span> <br><code>${gammaEff.toFixed(6)}</code><br>
    <span class="small muted">Observed decay rate factor (1/Œ≥<sub>eff</sub>)</span> <br><code>${decayRate.toExponential(3)}</code><br>
    <p class="small">Equations used: <code>Œ≥_t = ‚àö(1 - 2GM/rc¬≤)</code>, <code>Œì_dark = Œì‚ÇÄ(1 + Œ±¬∑œÅ)</code>, <code>Œì_eff = Œì‚ÇÄ / Œ≥_eff</code></p>
  `;
  rb.classList.remove('visible'); void rb.offsetWidth; rb.classList.add('visible');
}
document.getElementById('runCalcBtn').addEventListener('click', runCalc);

/* ==========================
   Friendly helpers
   ========================== */
function refreshEventOptions(){
  const sel = document.getElementById('eventSelect');
  sel.innerHTML = '';
  for(const k of Object.keys(events)){
    const o = document.createElement('option');
    o.value = k; o.textContent = k; sel.appendChild(o);
  }
}
</script>
</body>
</html>
