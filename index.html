<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BBH Simulator ‚Äî Overview, Events & Advanced Physics</title>

<!-- MathJax for LaTeX rendering -->
<script>
window.MathJax = {
  tex: {inlineMath: [['$','$'], ['\\(','\\)']]},
  svg: {fontCache: 'global'}
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
  :root{
    --bg:#05000a; --panel:#1a001f; --accent:#8000ff; --muted:#33003d; --text:#e5ccff;
    --h1:#ff66ff; --h2:#00ccff; --custom:#ffd166;
  }
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
  .tabs{display:flex;background:var(--panel);border-bottom:2px solid var(--muted);}
  .tabButton{flex:1;padding:12px;cursor:pointer;background:transparent;border:0;color:var(--text);font-weight:700}
  .tabButton.active{background:var(--accent);color:#fff}
  .container{padding:18px}
  h2{margin:6px 0 10px;color:var(--text)}
  canvas{display:block;margin:12px auto;border-radius:8px;background:radial-gradient(circle at center,#14001a 0%, #05000a 100%);box-shadow:0 6px 18px rgba(0,0,0,0.6);}
  label,input,select,button,textarea{margin:6px 6px 6px 0;padding:8px;border-radius:4px;border:none}
  input[type=range]{vertical-align:middle}
  .panel{background:rgba(30,0,40,0.6);padding:10px;border-radius:8px;border:1px solid var(--muted);max-width:1100px;margin:12px auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:0.9rem;color:#d6c7ff}
  .muted{color:#bdaeff}
  .btn{background:var(--accent);border-radius:6px;color:white;padding:8px 12px;border:0;cursor:pointer}
  .btn.secondary{background:#444}
  .legend{display:flex;gap:16px;align-items:center;justify-content:center;margin-top:8px;color:var(--text);font-size:0.95rem}
  .swatch{width:18px;height:10px;border-radius:4px;display:inline-block;margin-right:6px;vertical-align:middle;cursor:pointer; border:1px solid rgba(255,255,255,0.06)}
  .tooltip { position: absolute; background: rgba(20,10,30,0.95); color: #fff; padding:8px; border-radius:6px; border:1px solid rgba(120,90,200,0.25); max-width:360px; font-size:0.9rem; display:none; z-index:1000; }
  .tooltip .close { float:right; cursor:pointer; color:#ffd; margin-left:8px; font-weight:bold }
  pre { background:#070018; padding:8px; border-radius:6px; overflow:auto; color:#f0f0ff; }
  table.math { width:100%; border-collapse:collapse; }
  table.math td { vertical-align:top; padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); }
  .calc { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
  .output { background: rgba(255,255,255,0.03); padding:8px; border-radius:6px; min-width:180px; color:#ffd; }
  .smallMuted { font-size:0.85rem; color:#cfc3ff; margin-top:6px; }
</style>
</head>
<body>

<!-- Tabs -->
<div class="tabs">
  <button class="tabButton active" data-tab="overviewTab">Overview</button>
  <button class="tabButton" data-tab="eventsTab">Events</button>
  <button class="tabButton" data-tab="advancedTab">Advanced Physics</button>
</div>

<!-- Overview -->
<div id="overviewTab" class="container tabContent" style="display:block">
  <h2>üåå Black Hole Overview</h2>
  <div class="panel">
    <p class="small">A rotating black hole with an accretion disk. Click a swatch to see the formula/explanation. Click the link in the tooltip to open the advanced derivation.</p>
    <canvas id="bhCanvas" width="920" height="420"></canvas>

    <div class="legend" aria-hidden="true">
      <div data-tooltip="eh"><span class="swatch" style="background:rgba(140,80,255,0.35);"></span>Event Horizon</div>
      <div data-tooltip="ad"><span class="swatch" style="background:rgba(255,180,80,0.22);"></span>Accretion Disk</div>
      <div data-tooltip="jet"><span class="swatch" style="background:rgba(120,200,255,0.18);"></span>Relativistic Jet</div>
    </div>
  </div>
</div>

<!-- Events -->
<div id="eventsTab" class="container tabContent" style="display:none">
  <h2>üí´ Gravitational-Wave Events</h2>

  <div class="panel">
    <div class="row">
      <label for="eventSelect">Event</label>
      <select id="eventSelect"></select>

      <button id="runCustomBtn" class="btn">Run Custom</button>
      <button id="resetBtn" class="btn secondary">Reset Simulator</button>

      <div style="margin-left:auto" id="status">Audio: <span id="audioState">idle</span></div>
    </div>

    <div class="row" style="margin-top:8px">
      <label>M‚ÇÅ (M‚òâ)</label><input id="m1Input" type="number" value="30" step="0.1" min="1">
      <label>M‚ÇÇ (M‚òâ)</label><input id="m2Input" type="number" value="30" step="0.1" min="1">
      <label>Spin a*</label><input id="spinInput" type="range" min="0" max="1" step="0.01" value="0.5">
      <span id="spinVal" class="muted">0.50</span>
    </div>

    <canvas id="orbitCanvas" width="920" height="380"></canvas>

    <div class="row">
      <div style="flex:1">
        <canvas id="chirpCanvas" width="920" height="180"></canvas>
        <div style="margin-top:6px">
          <button id="playChirpBtn" class="btn">üîä Play Chirp</button>
          <button id="stopChirpBtn" class="btn secondary">‚èπ Stop</button>
          <button id="exportBtn" class="btn secondary" title="Export current params & waveform as JSON">‚¨á Export JSON</button>
          <span class="muted" style="margin-left:10px">Playhead shown on chirp canvas</span>
        </div>
      </div>

      <div style="width:340px;margin-left:16px">
        <div class="panel">
          <strong>Event Info</strong>
          <p id="eventDescription" class="small muted">‚Äî</p>
          <table style="width:100%;border-collapse:collapse;margin-top:8px;color:var(--text)">
            <tr><td class="small muted">Chirp mass</td><td id="chirpMass" style="text-align:right">‚Äî</td></tr>
            <tr><td class="small muted">Freq range</td><td id="freqRange" style="text-align:right">‚Äî</td></tr>
            <tr><td class="small muted">Estimated h</td><td id="gwStrain" style="text-align:right">‚Äî</td></tr>
            <tr><td class="small muted">Distance est.</td><td id="distance" style="text-align:right">‚Äî</td></tr>
          </table>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <strong>Scientific Summary</strong>
      <h4 class="small muted">Chirp Amplitude</h4>
      <canvas id="amplitudeCanvas" width="920" height="110"></canvas>
      <h4 class="small muted">Energy Loss</h4>
      <canvas id="energyCanvas" width="920" height="110"></canvas>
      <h4 class="small muted">Frequency evolution</h4>
      <canvas id="freqCanvas" width="920" height="110"></canvas>
    </div>
  </div>
</div>

<!-- Advanced Physics Tab -->
<div id="advancedTab" class="container tabContent" style="display:none">
  <h2>üìö Advanced Physics</h2>
  <div class="panel">
    <h3>I. Einstein field equations & action</h3>
    <table class="math">
      <tr><td>Classical Einstein equations</td><td>\(R_{\mu\nu} - \tfrac{1}{2} g_{\mu\nu} R = \kappa\, T_{\mu\nu}\)</td></tr>
      <tr><td>Quantum-corrected form (phenomenological)</td><td>\(G_{\mu\nu} = \kappa\big(T_{\mu\nu} + \mathcal{Q}_{\mu\nu}\big)\)</td></tr>
      <tr><td>Einstein‚ÄìHilbert action</td><td>\(S = \int \sqrt{-g}\,d^4x\;\left(\tfrac{1}{2\kappa} R + \mathcal{L}_{\text{matter}}\right)\)</td></tr>
    </table>

    <h3>II. Schwarzschild geometry & time dilation</h3>
    <p class="small">Schwarzschild radius and metric (static black hole):</p>
    <pre>\(r_s = \dfrac{2GM}{c^2}\)

\(ds^2 = -\left(1-\dfrac{r_s}{r}\right)c^2 dt^2 + \left(1-\dfrac{r_s}{r}\right)^{-1} dr^2 + r^2 d\Omega^2\)</pre>

    <p class="small">Gravitational time dilation (standard):</p>
    <pre>\(\Delta t' = \dfrac{\Delta t}{\sqrt{1 - \dfrac{2GM}{rc^2}}}\)</pre>

    <h4>Calculate time-dilation near Sagittarius A*</h4>
    <div class="calc">
      <label>Use the provided numbers or adjust:</label>
      <div style="display:flex;gap:6px;align-items:center">
        <label class="muted small">Mass (M‚òâ)</label>
        <input id="sgr_M" type="number" value="4300000" step="1" />
        <label class="muted small">Radius r (m)</label>
        <input id="sgr_r" type="number" value="7.8e17" step="1" />
        <button id="sgrCalc" class="btn">Compute Œ≥</button>
      </div>
      <div class="output" id="sgrResult">Œ≥ = ‚Äî</div>
    </div>
    <div class="smallMuted">Using constants: \(G=6.67430\times10^{-11}\,\mathrm{m^3kg^{-1}s^{-2}}\), \(c=3\times10^8\) m/s, solar mass \(M_\odot=1.989\times10^{30}\) kg.</div>

    <h3>III. Gravitational waves (with quantum correction)</h3>
    <pre>\(\Box\, h_{\mu\nu} = \dfrac{16\pi G}{c^4}\left( T_{\mu\nu} + Q_{\mu\nu} \right)\)</pre>

    <h3>IV. BH thermodynamics</h3>
    <pre>Hawking temperature:
\(T_H = \dfrac{\hbar c^3}{8\pi G M k_B}\)

Bekenstein‚ÄìHawking entropy:
\(S_{\mathrm{BH}} = \dfrac{k_B c^3 A}{4 G \hbar}\)</pre>

    <h3>V. Particle decay modifications (gravity & dark matter)</h3>
    <p class="small">Your decay relations:</p>
    <pre>\(\Gamma = \dfrac{\hbar}{\tau}\left(1 - \dfrac{r_s}{r}\right)\)

Dark-matter-modified decay:
\(\Gamma_{\rm dark} = \Gamma_0\left(1 + \alpha\,\rho_{\rm DM}\right)\)

Lifetime modified by DM compression:
\(\tau_D = \tau_0\, e^{\alpha D}\)</pre>

    <h4>Interactive dark-matter decay calculator</h4>
    <div class="calc">
      <label class="muted small">Base decay rate \(\Gamma_0\) (s‚Åª¬π)</label>
      <input id="dm_G0" type="number" value="1e-5" step="1e-6" />
      <label class="muted small">Œ± (coupling)</label>
      <input id="dm_alpha" type="number" value="1e20" step="1e18" />
      <label class="muted small">œÅ_DM (kg/m¬≥)</label>
      <input id="dm_rho" type="number" value="1e-21" step="1e-22" />
      <button id="dmCalc" class="btn">Compute Œì_dark</button>
      <div class="output" id="dmResult">Œì_dark = ‚Äî</div>
    </div>
    <div class="smallMuted">Note: typical local DM density ~\(10^{-21}\) kg/m¬≥ (order-of-magnitude); Œ± is phenomenological.</div>

    <h3>VI. Primordial Black Hole (PBH) DM profile</h3>
    <pre>\(\rho_{\rm DM}(r) = \dfrac{\rho_0}{\left(1 + \dfrac{r}{r_s}\right)^2}\)</pre>
    <div class="calc">
      <label class="muted small">œÅ‚ÇÄ (kg/m¬≥)</label><input id="pbh_rho0" type="number" value="1e-18" step="1e-19" />
      <label class="muted small">r_s (m)</label><input id="pbh_rs" type="number" value="1e9" step="1e6" />
      <label class="muted small">r (m)</label><input id="pbh_r" type="number" value="1e10" step="1e6" />
      <button id="pbhCalc" class="btn">Compute œÅ_DM(r)</button>
      <div class="output" id="pbhResult">œÅ_DM(r) = ‚Äî</div>
    </div>

    <h3>VII. Lensing (deflection angle)</h3>
    <pre>\(\delta\theta \approx \dfrac{4GM}{c^2 r}\)</pre>

    <h3>VIII. Compact reminder (Einstein eqn with Œõ)</h3>
    <pre>\(R_{\mu\nu} - \tfrac{1}{2} g_{\mu\nu} R + \Lambda g_{\mu\nu} = \dfrac{8\pi G}{c^4} T_{\mu\nu}\)</pre>

    <h3>IX. Path integral / action (quantization)</h3>
    <pre>\(S = \int \sqrt{-g}\, d^4x \left( \dfrac{1}{2\kappa} R + \mathcal{L}_{\rm matter} \right)\)</pre>

    <p class="smallMuted">You can use the calculators above to produce numbers to plug into simulators and to test how decay rates change under gravity and dark matter ‚Äî once these match your expectations I‚Äôll wire the same numeric formulas into the Event simulation outputs (waveform shape, amplitude evolution, and decay-related visual effects).</p>
  </div>
</div>

<!-- Tooltip container -->
<div id="tooltip" class="tooltip" role="dialog" aria-hidden="true">
  <span class="close" id="tooltipClose">√ó</span>
  <div id="tooltipContent"></div>
</div>

<script>
/* -----------------------
   Tabs handling
   ----------------------- */
document.querySelectorAll('.tabButton').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabButton').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
    // close tooltip if open
    tooltip.style.display='none'; tooltip.setAttribute('aria-hidden','true');
  });
});

/* -----------------------
   Overview drawing (stars, disk, horizon, jet)
   ----------------------- */
const bhCanvas = document.getElementById('bhCanvas');
const bhCtx = bhCanvas.getContext('2d');
const bhW = bhCanvas.width, bhH = bhCanvas.height;
const bhCx = bhW/2, bhCy = bhH/2;
const horizonR = 70;
const stars = Array.from({length:170}, ()=>({
  x: Math.random()*bhW, y: Math.random()*bhH, r: 0.5+Math.random()*1.1, phi: Math.random()*Math.PI*2, vx:(Math.random()-0.5)*0.06
}));
let bhHotAngle = 0;

function drawOverview(){
  bhCtx.clearRect(0,0,bhW,bhH);
  const g = bhCtx.createRadialGradient(bhCx,bhCy,10,bhCx,bhCy,300);
  g.addColorStop(0,'#070012'); g.addColorStop(1,'#010006');
  bhCtx.fillStyle = g; bhCtx.fillRect(0,0,bhW,bhH);

  // stars (mask)
  for(const s of stars){
    s.phi += 0.02 + Math.random()*0.01;
    s.x += s.vx; if(s.x < -2) s.x = bhW + 2; if(s.x > bhW+2) s.x = -2;
    const d = Math.hypot(s.x-bhCx, s.y-bhCy);
    if(d > horizonR + 12){
      bhCtx.beginPath();
      bhCtx.fillStyle = `rgba(255,255,255,${0.45 + 0.5*Math.sin(s.phi)})`;
      bhCtx.arc(s.x,s.y,s.r,0,Math.PI*2); bhCtx.fill();
    }
  }

  // accretion disk (amber rings)
  for(let i=0;i<40;i++){
    bhCtx.beginPath();
    bhCtx.arc(bhCx,bhCy,horizonR+8 + i*3,0,Math.PI*2);
    bhCtx.strokeStyle = `rgba(255,180,80,${0.006 + i*0.0006})`;
    bhCtx.stroke();
  }

  // event horizon outline (violet)
  bhCtx.beginPath(); bhCtx.arc(bhCx,bhCy,horizonR,0,Math.PI*2);
  bhCtx.strokeStyle = 'rgba(140,80,255,0.35)'; bhCtx.lineWidth = 2; bhCtx.stroke();

  // jet (soft vertical cone)
  bhCtx.fillStyle = 'rgba(120,200,255,0.06)';
  bhCtx.fillRect(bhCx-6, 0, 12, bhCy-120);

  // central horizon fill
  bhCtx.beginPath(); bhCtx.arc(bhCx,bhCy,horizonR,0,Math.PI*2); bhCtx.fillStyle='black'; bhCtx.fill();

  // hotspot
  const hx = bhCx + Math.cos(bhHotAngle) * 110;
  const hy = bhCy + Math.sin(bhHotAngle) * 34;
  bhCtx.beginPath(); bhCtx.arc(hx,hy,6,0,Math.PI*2); bhCtx.fillStyle = '#ffcc99'; bhCtx.fill();

  bhHotAngle += 0.026;
  requestAnimationFrame(drawOverview);
}
drawOverview();

/* -----------------------
   Tooltip & link to Advanced tab
   ----------------------- */
const tooltipData = {
  "eh": { html:`<strong>Event horizon</strong><br>r_s = 2 G M / c^2.<br><a class="advLink" data-target="I">Open derivation</a>` , targetSection:"I" },
  "ad": { html:`<strong>Accretion disk</strong><br>Viscous disk models (Novikov‚ÄìThorne).<br><a class="advLink" data-target="II">Open derivation</a>`, targetSection:"II" },
  "jet":{ html:`<strong>Relativistic jet</strong><br>Magnetic extraction of spin energy (Blandford‚ÄìZnajek).<br><a class="advLink" data-target="III">Open derivation</a>`, targetSection:"III" }
};
const tooltip = document.getElementById('tooltip');
const tooltipContent = document.getElementById('tooltipContent');
const tooltipClose = document.getElementById('tooltipClose');

document.querySelectorAll('.legend div').forEach(div=>{
  div.style.position='relative';
  const key = div.getAttribute('data-tooltip');
  div.addEventListener('click',(ev)=>{
    const rect = ev.currentTarget.getBoundingClientRect();
    tooltipContent.innerHTML = tooltipData[key].html;
    tooltip.style.left = (rect.left + window.scrollX + rect.width/2 - 180) + 'px';
    tooltip.style.top  = (rect.top + window.scrollY - 120) + 'px';
    tooltip.style.display = 'block'; tooltip.setAttribute('aria-hidden','false');
    // wire adv link
    tooltip.querySelectorAll('.advLink').forEach(a=>{
      a.addEventListener('click', (e)=>{
        const t = e.currentTarget.getAttribute('data-target');
        // open advanced tab and scroll to section
        document.querySelectorAll('.tabButton').forEach(b=>b.classList.remove('active'));
        document.querySelector('[data-tab="advancedTab"]').classList.add('active');
        document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
        document.getElementById('advancedTab').style.display='block';
        // scroll to section heading if matching
        const adv = document.getElementById('advancedTab');
        if(t==='I') adv.querySelector('h3').scrollIntoView({behavior:'smooth'});
        if(t==='II') adv.querySelectorAll('h3')[1].scrollIntoView({behavior:'smooth'});
        if(t==='III') adv.querySelectorAll('h3')[2].scrollIntoView({behavior:'smooth'});
        tooltip.style.display='none'; tooltip.setAttribute('aria-hidden','true');
      });
    });
  });
});
tooltipClose.addEventListener('click', ()=>{ tooltip.style.display='none'; tooltip.setAttribute('aria-hidden','true'); });

/* -----------------------
   Events DB + UI (keep your expanded set if desired)
   ----------------------- */
const eventSelect = document.getElementById('eventSelect');
const events = {
  "GW150914": { m1:36, m2:29, spin:0.3, color:'#ff66ff', desc: "GW150914 ‚Äî first detection (2015): 36 + 29 M‚òâ." },
  "GW170104": { m1:31, m2:19, spin:0.45, color:'#00ccff', desc: "GW170104 ‚Äî 31 + 19 M‚òâ (2017)." },
  "GW170608": { m1:12, m2:7, spin:0.25, color:'#66ff99', desc: "GW170608 ‚Äî lighter system, 12 + 7 M‚òâ." },
  "GW190521": { m1:85, m2:66, spin:0.7, color:'#ff9933', desc: "GW190521 ‚Äî very massive (85 + 66 M‚òâ)." },
  "GW190814": { m1:23, m2:2.6, spin:0.05, color:'#ffcc00', desc: "GW190814 ‚Äî asymmetric (possible BH+NS)." },
  "GW200115": { m1:6, m2:1.5, spin:0.2, color:'#33aaff', desc: "GW200115 ‚Äî NS‚ÄìBH candidate." },
  "Custom":    { m1:30, m2:30, spin:0.5, color:'#ffd166', desc: "Custom system." }
};
for(const k in events){ const o=document.createElement('option'); o.value=k; o.textContent=k; eventSelect.appendChild(o); }

/* -----------------------
   Orbit canvas + trails
   ----------------------- */
const orbitCanvas = document.getElementById('orbitCanvas');
const ox = orbitCanvas.getContext('2d');
const orbitW = orbitCanvas.width, orbitH = orbitCanvas.height;
let angle = 0;
let trailsA = [], trailsB = [];
const TRAIL_MAX = 180;
let orbitAnimHandle = null;

function startOrbit(m1,m2,spin,accent){
  if(orbitAnimHandle) cancelAnimationFrame(orbitAnimHandle);
  trailsA = []; trailsB = []; angle = 0;
  function frame(){
    ox.clearRect(0,0,orbitW,orbitH);
    const g = ox.createRadialGradient(orbitW/2, orbitH/2, 20, orbitW/2, orbitH/2, 500);
    g.addColorStop(0,'rgba(20,0,40,0.6)'); g.addColorStop(1,'rgba(0,0,0,1)');
    ox.fillStyle = g; ox.fillRect(0,0,orbitW,orbitH);

    const cx = orbitW/2, cy = orbitH/2;
    const rA = 80, rB = 160;
    const xA = cx + Math.cos(angle) * rA, yA = cy + Math.sin(angle) * rA;
    const xB = cx - Math.cos(angle) * rB, yB = cy - Math.sin(angle) * rB;

    trailsA.push({x:xA,y:yA}); trailsB.push({x:xB,y:yB});
    if(trailsA.length>TRAIL_MAX) trailsA.shift(); if(trailsB.length>TRAIL_MAX) trailsB.shift();

    for(let i=0;i<trailsA.length;i++){
      const a = i / trailsA.length;
      ox.fillStyle = hexToRgba(accent, 0.14 * a);
      ox.fillRect(trailsA[i].x-1, trailsA[i].y-1, 3, 3);
    }
    for(let i=0;i<trailsB.length;i++){
      const a = i / trailsB.length;
      ox.fillStyle = hexToRgba(accent, 0.16 * a);
      ox.fillRect(trailsB[i].x-1, trailsB[i].y-1, 4, 4);
    }

    ox.beginPath(); ox.arc(xA,yA,12,0,Math.PI*2); ox.fillStyle = accent; ox.fill();
    ox.beginPath(); ox.arc(xB,yB,18,0,Math.PI*2); ox.fillStyle = shadeColor(accent,-20); ox.fill();

    ox.beginPath(); ox.arc(cx + Math.cos(angle*1.28 + spin) * (rA*1.05), cy + Math.sin(angle*1.28 + spin)*(rA*0.58), 4, 0, Math.PI*2);
    ox.fillStyle = 'rgba(255,220,180,0.7)'; ox.fill();

    angle += 0.018 + spin * 0.012;
    orbitAnimHandle = requestAnimationFrame(frame);
  }
  frame();
}

/* -----------------------
   Chirp waveform & audio (Option A)
   ----------------------- */
// (same code as before)
const chirpCanvas = document.getElementById('chirpCanvas');
const cctx = chirpCanvas.getContext('2d');
const waveform = new Float32Array(1400);
let audioCtx = null, osc = null, oscHarm = null, gainNode = null, gainHarm = null;
let playStart = 0, playDur = 0, playRAF = null;
let currentAccent = '#ff66ff';

function generateWaveformSamples(m1,m2,spin){
  const N = waveform.length;
  const Mc = Math.pow((m1*m2)**(3/5)/(m1+m2)**(1/5),1);
  const f0 = 20 + spin*15;
  const f1 = 300 + (Mc/30)*300;
  for(let i=0;i<N;i++){
    const t = i/N;
    const env = Math.pow(t,2) * Math.exp(-1.2*(1-t));
    const freq = f0 + Math.pow(t,1.6) * (f1 - f0);
    waveform[i] = env * Math.sin(2*Math.PI * freq * t * 1.6);
  }
  drawChirp(-1);
}

function drawChirp(playIdx=-1){
  const W = chirpCanvas.width, H = chirpCanvas.height;
  cctx.clearRect(0,0,W,H);
  cctx.beginPath();
  for(let i=0;i<waveform.length;i++){
    const x = i/waveform.length * W;
    const y = H/2 - waveform[i] * (H/2) * 0.9;
    if(i===0) cctx.moveTo(x,y); else cctx.lineTo(x,y);
  }
  cctx.strokeStyle = currentAccent; cctx.lineWidth = 2; cctx.stroke();

  if(playIdx >= 0){
    const px = playIdx / waveform.length * W;
    cctx.beginPath(); cctx.moveTo(px,0); cctx.lineTo(px,H);
    cctx.strokeStyle='rgba(255,80,80,0.9)'; cctx.lineWidth=1.5; cctx.stroke();
  }
}

/* Play chirp with harmonic */
async function playChirpAudio(m1,m2,spin,accent){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') await audioCtx.resume().catch(()=>{});
  stopChirpAudio();

  const Mc = Math.pow((m1*m2)**(3/5)/(m1+m2)**(1/5),1);
  const fStart = 20 + spin*10;
  const fEnd   = 400 + (Mc/30)*200;
  const duration = Math.max(0.8, 3.2 - (Mc/40));

  osc = audioCtx.createOscillator();
  gainNode = audioCtx.createGain();
  osc.type = 'sine';
  osc.connect(gainNode); gainNode.connect(audioCtx.destination);

  oscHarm = audioCtx.createOscillator();
  gainHarm = audioCtx.createGain();
  oscHarm.type = 'sine';
  oscHarm.connect(gainHarm); gainHarm.connect(audioCtx.destination);

  const now = audioCtx.currentTime;
  osc.frequency.setValueAtTime(Math.max(fStart,1), now);
  osc.frequency.exponentialRampToValueAtTime(Math.max(fEnd, fStart+1), now + duration);
  oscHarm.frequency.setValueAtTime(Math.max(fStart*2,2), now);
  oscHarm.frequency.exponentialRampToValueAtTime(Math.max(fEnd*2, fStart*2+2), now + duration);

  gainNode.gain.setValueAtTime(0.0001, now);
  gainNode.gain.linearRampToValueAtTime(0.28, now + 0.03);
  gainNode.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  gainHarm.gain.setValueAtTime(0.0001, now);
  gainHarm.gain.linearRampToValueAtTime(0.06, now + 0.03);
  gainHarm.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  osc.start(now); osc.stop(now + duration + 0.05);
  oscHarm.start(now); oscHarm.stop(now + duration + 0.05);

  playStart = performance.now();
  playDur = duration * 1000;
  document.getElementById('audioState').textContent = 'playing';
  animatePlayheadAndGraphs(accent);
}
function stopChirpAudio(){
  try{ if(osc) osc.stop(); }catch(e){}
  try{ if(oscHarm) oscHarm.stop(); }catch(e){}
  try{ if(gainNode) gainNode.disconnect(); }catch(e){}
  try{ if(gainHarm) gainHarm.disconnect(); }catch(e){}
  try{ if(osc) osc.disconnect(); }catch(e){}
  try{ if(oscHarm) oscHarm.disconnect(); }catch(e){}
  osc = null; oscHarm = null; gainNode = null; gainHarm = null;
  document.getElementById('audioState').textContent = 'idle';
  if(playRAF){ cancelAnimationFrame(playRAF); playRAF = null; drawChirp(-1); drawSummaryGraphs(currentAccent, 0); }
}
function animatePlayheadAndGraphs(accent){
  const start = playStart;
  function step(){
    const now = performance.now();
    const elapsed = now - start;
    if(elapsed >= playDur){
      stopChirpAudio(); return;
    }
    const prog = elapsed / playDur;
    const idx = Math.floor(prog * waveform.length);
    drawChirp(idx);
    drawPulseOverlay(prog);
    drawSummaryGraphs(accent, prog);
    playRAF = requestAnimationFrame(step);
  }
  step();
}
function drawPulseOverlay(progress){
  const W = chirpCanvas.width, H = chirpCanvas.height;
  const centerX = progress * W;
  const width = Math.max(6, 0.04 * W * (0.4 + progress));
  const g = cctx.createLinearGradient(centerX - width, 0, centerX + width, 0);
  g.addColorStop(0, 'rgba(0,0,0,0)');
  g.addColorStop(0.35, hexToRgba(currentAccent, 0.22));
  g.addColorStop(0.65, hexToRgba(currentAccent, 0.22));
  g.addColorStop(1, 'rgba(0,0,0,0)');
  cctx.fillStyle = g; cctx.fillRect(centerX - width, 0, width*2, H);
}

/* -----------------------
   Summary graphs
   ----------------------- */
function drawSummaryGraphs(accent, progress=0){
  const ampCtx = document.getElementById('amplitudeCanvas').getContext('2d');
  const engCtx = document.getElementById('energyCanvas').getContext('2d');
  const fqCtx  = document.getElementById('freqCanvas').getContext('2d');
  drawGraphAnim(ampCtx, accent, t => Math.pow(t*(0.3+0.7*progress+0.5), 3) * Math.sin(40*t*Math.PI), progress);
  drawGraphAnim(engCtx, accent, t => Math.pow(t*(0.2+0.8*progress+0.4), 2.5) * Math.exp(-3*t*(1 - 0.4*(1-progress))), progress);
  drawGraphAnim(fqCtx,  accent, t => Math.pow(t*(0.6+0.4*progress+0.2), 1.6), progress);
}
function drawGraphAnim(ctx, color, fn, progress){
  const W = ctx.canvas.width, H = ctx.canvas.height;
  ctx.clearRect(0,0,W,H); ctx.beginPath();
  for(let i=0;i<W;i++){
    const t = i / W;
    const y = H/2 - fn(t) * H/3;
    if(i===0) ctx.moveTo(i,y); else ctx.lineTo(i,y);
  }
  ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
}

/* -----------------------
   Helpers
   ----------------------- */
function hexToRgba(hex, alpha=1.0){
  if(!hex) return `rgba(200,200,200,${alpha})`;
  if(hex.startsWith('rgba') || hex.startsWith('rgb')) {
    const nums = hex.replace(/rgba?|\(|\)|\s/g,'').split(',').map(Number);
    return `rgba(${nums[0]},${nums[1]},${nums[2]},${alpha})`;
  }
  const h = hex.replace('#','');
  const r = parseInt(h.substring(0,2),16), g = parseInt(h.substring(2,4),16), b = parseInt(h.substring(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function shadeColor(hex, percent){
  if(!hex.startsWith('#')) return hex;
  const h = hex.replace('#','');
  const r = clamp(parseInt(h.substring(0,2),16) + Math.round(2.55*percent),0,255);
  const g = clamp(parseInt(h.substring(2,4),16) + Math.round(2.55*percent),0,255);
  const b = clamp(parseInt(h.substring(4,6),16) + Math.round(2.55*percent),0,255);
  return `rgb(${r},${g},${b})`;
}
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }

/* -----------------------
   UI wiring + interactions
   ----------------------- */
const playChirpBtn = document.getElementById('playChirpBtn');
const stopChirpBtn = document.getElementById('stopChirpBtn');
const exportBtn = document.getElementById('exportBtn');
const runCustomBtn = document.getElementById('runCustomBtn');
const resetBtn = document.getElementById('resetBtn');
const m1Input = document.getElementById('m1Input');
const m2Input = document.getElementById('m2Input');
const spinInput = document.getElementById('spinInput');
const spinVal = document.getElementById('spinVal');
const audioState = document.getElementById('audioState');
spinVal.textContent = Number(spinInput.value).toFixed(2);
spinInput.addEventListener('input', ()=> spinVal.textContent = Number(spinInput.value).toFixed(2) );

let selectedEventKey = 'GW150914';
function loadEvent(key){
  const ev = events[key];
  if(!ev) return;
  selectedEventKey = key;
  eventSelect.value = key;
  m1Input.value = ev.m1; m2Input.value = ev.m2; spinInput.value = ev.spin; spinVal.textContent = Number(ev.spin).toFixed(2);
  document.getElementById('eventDescription').textContent = ev.desc;
  currentAccent = ev.color;
  generateWaveformSamples(ev.m1, ev.m2, ev.spin);
  drawSummaryGraphs(ev.color, 0);
  startOrbit(ev.m1, ev.m2, ev.spin, ev.color);
  updateSummary(ev.m1, ev.m2);
}
function updateSummary(m1,m2){
  const chirpMass=Math.pow((m1*m2)**(3/5)/(m1+m2)**(1/5),1);
  document.getElementById('chirpMass').textContent=chirpMass.toFixed(2)+" M‚òâ";
  document.getElementById('freqRange').textContent="20‚Äì400 Hz";
  document.getElementById('gwStrain').textContent=(4e-21*(chirpMass/30)**(5/3)).toExponential(2);
  document.getElementById('distance').textContent=`${(chirpMass*40).toFixed(0)} million ly`;
}

/* populate/select handlers */
eventSelect.addEventListener('change', ()=> loadEvent(eventSelect.value));
runCustomBtn.addEventListener('click', ()=>{
  const m1 = clamp(parseFloat(m1Input.value) || 30, 1, 1e6);
  const m2 = clamp(parseFloat(m2Input.value) || 30, 1, 1e6);
  const spin = clamp(parseFloat(spinInput.value) || 0.5, 0, 1);
  events['Custom'] = { m1, m2, spin, color: '#ffd166', desc: `Custom: ${m1} + ${m2} M‚òâ, spin ${spin}` };
  loadEvent('Custom');
});
resetBtn.addEventListener('click', ()=>{
  trailsA = []; trailsB = []; angle = 0;
  loadEvent(selectedEventKey || 'GW150914');
  stopChirpAudio();
});
playChirpBtn.addEventListener('click', async ()=>{
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') await audioCtx.resume().catch(()=>{});
  const ev = events[eventSelect.value] || events['Custom'];
  generateWaveformSamples(ev.m1, ev.m2, ev.spin);
  playChirpAudio(ev.m1, ev.m2, ev.spin, ev.color);
});
stopChirpBtn.addEventListener('click', ()=> stopChirpAudio());
exportBtn.addEventListener('click', ()=>{
  const ev = events[eventSelect.value] || events['Custom'];
  const params = {
    simulation_name: eventSelect.value,
    m1: ev.m1, m2: ev.m2, spin: ev.spin,
    accent: ev.color,
    timestamp: new Date().toISOString()
  };
  const samples = Array.from(waveform).map((v,i)=> Math.round(v*1e6)/1e6 ); // reduced precision
  const payload = { params, samples, sample_rate: waveform.length / 3.0 }; // approximate rate
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `${eventSelect.value}_waveform.json`; a.click();
  URL.revokeObjectURL(url);
});

/* -----------------------
   Advanced calculators wiring
   ----------------------- */
// 1) Sgr A* time dilation
document.getElementById('sgrCalc').addEventListener('click', ()=>{
  const G = 6.67430e-11;
  const c = 3e8;
  const Msun = 1.989e30;
  const Msol = parseFloat(document.getElementById('sgr_M').value); // in solar masses
  const r = parseFloat(document.getElementById('sgr_r').value);
  const M = Msol * Msun;
  // using user's formula gamma = sqrt(1 - GM/(r c^2))
  const inside = 1 - (G*M)/(r*c*c);
  const gamma = inside > 0 ? Math.sqrt(inside) : 0;
  document.getElementById('sgrResult').textContent = `Œ≥ = ${gamma.toPrecision(6)} (dimensionless).`;
});

// 2) Dark matter decay calc
document.getElementById('dmCalc').addEventListener('click', ()=>{
  const G0 = parseFloat(document.getElementById('dm_G0').value) || 0;
  const alpha = parseFloat(document.getElementById('dm_alpha').value) || 0;
  const rho = parseFloat(document.getElementById('dm_rho').value) || 0;
  const Gdark = G0 * (1 + alpha * rho);
  document.getElementById('dmResult').textContent = `Œì_dark = ${Gdark.toExponential(6)} s‚Åª¬π`;
});

// 3) PBH DM profile
document.getElementById('pbhCalc').addEventListener('click', ()=>{
  const rho0 = parseFloat(document.getElementById('pbh_rho0').value) || 0;
  const rs = parseFloat(document.getElementById('pbh_rs').value) || 1;
  const r = parseFloat(document.getElementById('pbh_r').value) || 1;
  const val = rho0 / Math.pow(1 + r/rs, 2);
  document.getElementById('pbhResult').textContent = `œÅ_DM(r) = ${val.toExponential(6)} kg/m¬≥`;
});

/* ensure audio resumes on first gesture */
['click','keydown','pointerdown','touchstart'].forEach(evt => {
  window.addEventListener(evt, ()=> {
    if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  }, { once:true });
});

/* initial load */
loadEvent('GW150914');

</script>
</body>
</html>
