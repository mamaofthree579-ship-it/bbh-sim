<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BBH Visualizer — Dual Orbits (Preset + Custom)</title>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<!-- JSZip for ZIP export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
  :root{
    --nebula1:#071335; --nebula2:#2b0b3a;
    --accent1:#ffb85a; --accent2:#00d4ff; --muted:#98a8bf; --panel:rgba(255,255,255,0.02);
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#eaf6ff;-webkit-font-smoothing:antialiased;}
  body{
    background:
      radial-gradient(circle at 10% 10%, rgba(255,255,255,0.02), transparent 6%),
      radial-gradient(circle at 70% 80%, rgba(255,255,255,0.02), transparent 12%),
      radial-gradient(circle at 40% 30%, rgba(12,24,60,0.20), transparent 35%),
      linear-gradient(180deg,var(--nebula1),var(--nebula2));
  }

  /* stars */
  #stars{position:fixed;inset:0;z-index:0;pointer-events:none;
    background-image:
      radial-gradient(circle, rgba(255,255,255,.98) 1px, transparent 2px),
      radial-gradient(circle, rgba(255,255,255,.9) 1px, transparent 2px);
    background-size:760px 760px,430px 430px;mix-blend-mode:screen;opacity:.06;}

  .container{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:12px;}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:8px 0;}
  .brand{display:flex;align-items:center;gap:12px;}
  .title{color:var(--accent2);font-weight:700;font-size:1.05rem;}
  .tabs{display:flex;gap:8px;}
  .tab-btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);color:#eaf6ff;padding:8px 12px;border-radius:8px;cursor:pointer;}
  .tab-btn.active{background:linear-gradient(90deg, rgba(255,184,90,0.06), rgba(0,212,255,0.05));box-shadow:0 6px 18px rgba(0,0,0,0.38);border-color:rgba(0,212,255,0.12);}

  .layout{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px;}
  @media(min-width:1000px){.layout{grid-template-columns:1fr 420px;}}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:10px;box-shadow:0 10px 40px rgba(0,0,0,0.45);}

  .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .muted{color:var(--muted);font-size:0.92rem;}
  .plot{width:100%;border-radius:8px;background:transparent;}
  .plot-main{height:300px;}
  .plot-spec{height:180px;margin-top:10px;}
  .orbit{height:320px;margin-top:10px;}
  .player{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;margin-top:8px;border-radius:8px;background:rgba(0,0,0,0.18);}
  .player button{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#eaf6ff;padding:6px 8px;border-radius:6px;cursor:pointer;}
  .infoButton{position:fixed;right:14px;top:12px;z-index:30;background:var(--panel);border:1px solid rgba(255,255,255,0.04);color:#eaf6ff;padding:8px 10px;border-radius:10px;cursor:pointer;}
  .aboutModal{position:fixed;right:14px;top:56px;z-index:40;width:320px;max-width:88vw;background:rgba(0,0,0,0.66);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.04);display:none;color:#eaf6ff;}
  .footer{text-align:center;color:var(--muted);padding:10px;font-size:0.9rem;margin-top:12px;}
  input,select,button{font-size:0.95rem;}
  .export-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#eaf6ff;padding:6px 8px;border-radius:6px;cursor:pointer;}
  .small{font-size:0.86rem;color:var(--muted);}
  .explainer{margin-top:6px;margin-bottom:6px;color:var(--muted);font-size:0.95rem;}
</style>
</head>
<body>
  <div id="stars" aria-hidden="true"></div>

  <div class="container">
    <header>
      <div class="brand">
        <div class="title">Open BBH Visualizer — Dual Orbits</div>
        <div class="tabs" role="tablist">
          <button class="tab-btn active" id="tabPreset">Preset Events</button>
          <button class="tab-btn" id="tabCustom">Custom Simulation</button>
        </div>
      </div>
      <div class="muted">v3.8 — Separate Orbit Views • Export .zip/.json</div>
    </header>

    <div class="layout">
      <!-- LEFT: Main content area -->
      <div>
        <!-- Preset card -->
        <div id="presetCard" class="card" style="display:block;">
          <div class="controls-row">
            <label class="muted">Event:</label>
            <select id="presetEventSelect">
              <option value="GW150914">GW150914</option>
              <option value="GW170104">GW170104</option>
              <option value="GW170814">GW170814</option>
              <option value="GW190521">GW190521</option>
            </select>
            <button id="presetRun">Run Simulation</button>

            <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
              <button id="presetSound">Enable Sound</button>
              <button id="presetExportJSON" class="export-btn">Export Params (.json)</button>
              <button id="presetExportZIP" class="export-btn">Export Package (.zip)</button>
            </div>
          </div>

          <!-- explainer above orbit -->
          <div class="explainer">orange = BH1 · blue = BH2</div>

          <!-- Preset orbit + player (separate view) -->
          <div id="presetOrbit" class="plot orbit"></div>
          <div class="player" id="presetPlayer">
            <button id="presetPlay">Play</button>
            <button id="presetPause">Pause</button>
            <button id="presetRestart">Restart</button>
            <div class="small muted">Preset simulation player</div>
          </div>

          <!-- waveform, spec, energy -->
          <div id="presetWave" class="plot plot-main" style="margin-top:10px;"></div>
          <div id="presetSpec" class="plot plot-spec"></div>
          <div id="presetEnergy" class="plot" style="height:140px;margin-top:10px;"></div>
        </div>

        <!-- Custom card -->
        <div id="customCard" class="card" style="display:none;">
          <div class="controls-row">
            <label class="muted">Mode:</label>
            <select id="customMode"><option value="interactive">Interactive</option><option value="quick">Quick</option></select>
            <button id="customRun">Run Custom Simulation</button>
            <div style="margin-left:auto;display:flex;gap:6px;align-items:center;">
              <button id="customSound">Enable Sound</button>
              <button id="customExportJSON" class="export-btn">Export Params (.json)</button>
              <button id="customExportZIP" class="export-btn">Export Package (.zip)</button>
            </div>
          </div>

          <div class="small muted" style="margin-top:8px;">Adjust masses (M☉), spins (visual), and separation; then Run Custom Simulation.</div>

          <div style="margin-top:10px;" class="card">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
              <label>m₁ <input id="c_m1" type="number" value="36" min="5" max="200" style="width:90px"></label>
              <label>m₂ <input id="c_m2" type="number" value="29" min="5" max="200" style="width:90px"></label>
              <label>spin₁ <input id="c_s1" type="number" step="0.01" value="0.3" style="width:80px"></label>
              <label>spin₂ <input id="c_s2" type="number" step="0.01" value="0.2" style="width:80px"></label>
              <label>sep <input id="c_sep" type="number" value="15" min="6" style="width:80px"></label>
              <label class="muted">Trail</label>
              <input id="trailLen" type="range" min="5" max="120" value="40">
              <span id="trailVal" class="muted">40</span>
            </div>
          </div>

          <!-- explainer above orbit -->
          <div class="explainer">orange = BH1 · blue = BH2</div>

          <!-- Custom orbit + player (separate) -->
          <div id="customOrbit" class="plot orbit"></div>
          <div class="player" id="customPlayer">
            <button id="customPlay">Play</button>
            <button id="customPause">Pause</button>
            <button id="customRestart">Restart</button>
            <div class="small muted">Custom simulation player</div>
          </div>

          <div id="customWave" class="plot plot-main" style="margin-top:10px;"></div>
          <div id="customSpec" class="plot plot-spec"></div>
          <div id="customEnergy" class="plot" style="height:140px;margin-top:10px;"></div>
        </div>
      </div>

      <!-- RIGHT column: info & notes -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>Notes</strong></div>
            <div class="muted small">Educational demo</div>
          </div>
          <div style="margin-top:8px" class="small muted">
            This demo uses a toy chirp generator for visualization. Export packages to include waveform CSV and params. For research-grade waveforms, upload NR/LIGO h(t) files.
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><strong>About / Credits</strong></div>
            <div class="muted small">Open BBH Sim Project</div>
          </div>
          <div style="margin-top:8px" class="small muted">
            Built with Plotly. Includes in-browser ZIP export (JSZip). Presets are simplified and for outreach only.
          </div>
        </div>
      </div>
    </div>

    <button id="aboutBtn" class="infoButton" title="About">ℹ️</button>
    <div id="aboutModal" class="aboutModal" role="dialog" aria-hidden="true">
      <div style="font-weight:700;margin-bottom:8px">About this Visualizer</div>
      <div class="small muted">This interactive visualization simulates binary black hole inspirals (toy model). Two BHs orbit, radiate a chirp, and inspiral. For research-quality data, load NR or GWOSC waveforms.</div>
      <hr style="margin:8px 0;border-color:rgba(255,255,255,0.04)">
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;"><button id="aboutClose">Close</button></div>
    </div>

    <div class="footer">Open BBH Visualizer — Dual Orbits • v3.8</div>
  </div>

<script>
/* ============================
 Utilities
 ============================ */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function linspace(a,b,n){const out=[];for(let i=0;i<n;i++) out.push(a+(b-a)*i/(n-1));return out;}
function downloadBlob(blob, filename){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},150); }

/* ============================
 Toy chirp generator
 ============================ */
function generateChirp(params){
  const m1 = params.m1 || 36, m2 = params.m2 || 29;
  const total = Math.max(1, m1 + m2);
  const chirpMass = Math.pow((m1*m2), 3/5) / Math.pow(total, 1/5);
  const duration = clamp(5 * (30 / Math.max(1,chirpMass)), 2.2, 12); // seconds
  const sr = 1024;
  const N = Math.round(duration * sr);
  const t = new Array(N), h = new Array(N), freq = new Array(N);
  const f0 = 25 * Math.sqrt(30 / Math.max(1,chirpMass));
  const f1 = 600 * Math.sqrt(30 / Math.max(1,chirpMass));
  for(let i=0;i<N;i++){
    const tt = i / sr;
    const tau = tt / duration;
    const fr = f0 + (f1 - f0) * Math.pow(tau, 3.0);
    freq[i] = fr; t[i] = tt;
    const amp = Math.pow(tau, 1.8) * Math.exp(-2.0 * (1 - tau));
    h[i] = amp * Math.sin(2 * Math.PI * fr * tt);
  }
  return { t, h, freq, duration };
}

/* ============================
 Plot helpers (Plotly)
 ============================ */
function plotWave(elid, ts, title){
  const tr = { x: ts.t, y: ts.h, mode: 'lines', line: { color: '#ffffff' } };
  const layout = { title, margin:{t:36,l:50,r:16,b:36}, paper_bgcolor:'transparent', plot_bgcolor:'transparent', xaxis:{title:'Time (s)'}, yaxis:{title:'Strain'} };
  Plotly.react(elid, [tr], layout, { displayModeBar:false, responsive:true });
}
function plotSpec(elid, ts, title){
  const w=256, hop=128, mags=[];
  for(let i=0;i+w<ts.h.length;i+=hop) mags.push(ts.h.slice(i,i+w).map(v=>Math.abs(v)));
  const layout = { title, margin:{t:36,l:50,r:16,b:36}, paper_bgcolor:'transparent', plot_bgcolor:'transparent' };
  Plotly.react(elid, [{ z: mags, type:'heatmap', colorscale:'Viridis' }], layout, { displayModeBar:false, responsive:true });
}
function plotEnergy(elid, ts){
  const step = Math.max(1, Math.round(ts.h.length / 200));
  const p=[];
  for(let i=0;i<ts.h.length;i+=step){ const a=Math.abs(ts.h[i]); const f = ts.freq[i]||1; p.push(a*a*f*f); }
  const x = linspace(0, ts.duration, p.length);
  Plotly.react(elid, [{ x, y:p, type:'scatter', mode:'lines', line:{color:'#ffb86b'} }], { title:'Estimated Radiated Power (toy)', margin:{t:28,l:50,r:16,b:36}, paper_bgcolor:'transparent', plot_bgcolor:'transparent' }, {displayModeBar:false, responsive:true});
}

/* ============================
 Orbit initialization (two separate orbits)
 ============================ */
function initOrbit(elid){
  const data = [
    { x:[0], y:[0], z:[0], type:'scatter3d', mode:'markers', marker:{size:14,color:'rgb(255,160,64)'}, name:'BH1' },
    { x:[0], y:[0], z:[0], type:'scatter3d', mode:'markers', marker:{size:12,color:'rgb(0,212,255)'}, name:'BH2' },
    { x:[], y:[], z:[], type:'scatter3d', mode:'markers', marker:{size:6,color:[],opacity:1}, name:'Trail', showlegend:false }
  ];
  const layout = {
    margin:{t:10,l:10,r:10,b:10},
    scene:{ camera:{ eye:{x:1.2,y:1.0,z:0.7} }, xaxis:{visible:false}, yaxis:{visible:false}, zaxis:{visible:false} },
    paper_bgcolor:'transparent', plot_bgcolor:'transparent'
  };
  Plotly.react(elid, data, layout, { displayModeBar:false, responsive:true });
}
initOrbit('presetOrbit'); initOrbit('customOrbit');

function updateOrbit(elid, b1, b2, trailPts){
  const xs = trailPts.map(p=>p.x), ys = trailPts.map(p=>p.y), zs = trailPts.map(p=>p.z);
  Plotly.restyle(elid, {'x':[[b1[0]],[b2[0]], xs], 'y':[[b1[1]],[b2[1]], ys], 'z':[[b1[2]],[b2[2]], zs]}, [0,1,2]);
  const colors = trailPts.map(p=>`rgba(${p.color[0]},${p.color[1]},${p.color[2]},${p.alpha.toFixed(3)})`);
  Plotly.restyle(elid, {'marker.color':[null,null,colors]}, [0,1,2]);
}

/* compute positions for inspiral */
function computePositions(frameIdx, ts, params){
  const idx = clamp(frameIdx, 0, ts.t.length - 1);
  const fr = ts.freq[idx];
  const baseRadius = clamp(params.sep * 0.04, 0.06, 1.8);
  const shrink = clamp((fr / (fr + 250)), 0, 0.95);
  const tau = idx / Math.max(1, ts.t.length - 1);
  const radius = baseRadius * (1 - 0.6 * shrink) * (1 - 0.5 * tau);
  const total = Math.max(1, params.m1 + params.m2);
  const r1 = radius * (params.m2 / total);
  const r2 = radius * (params.m1 / total);
  const speed = 0.04 * (1 + fr / 200) * (1 + total / 120);
  const theta = frameIdx * speed * 0.45;
  const tilt = 0.2;
  const x1 = r1 * Math.cos(theta), y1 = r1 * Math.sin(theta), z1 = tilt * Math.sin(theta*0.7);
  const x2 = -r2 * Math.cos(theta), y2 = -r2 * Math.sin(theta), z2 = -tilt * Math.sin(theta*0.7);
  return { bh1:[x1,y1,z1], bh2:[x2,y2,z2], freq:fr };
}

/* trail helpers */
function pushTrail(queue, pos, maxLen){ queue.push(pos.slice()); while(queue.length>maxLen) queue.shift(); }
function trailToPoints(queue, colorRGB){ const out=[]; const L = queue.length; for(let i=0;i<L;i++){ const frac = i/Math.max(1,L-1); const alpha = 0.12 + 0.85*frac; out.push({x:queue[i][0],y:queue[i][1],z:queue[i][2],alpha,color:colorRGB}); } return out; }

/* ============================
 Presets and active states (separate for preset & custom)
 ============================ */
const PRESETS = {
  GW150914:{m1:36,m2:29,spin1:0.3,spin2:0.2,sep:15},
  GW170104:{m1:31,m2:19,spin1:0.1,spin2:0.05,sep:14},
  GW170814:{m1:30,m2:25,spin1:0.2,spin2:0.1,sep:15},
  GW190521:{m1:85,m2:66,spin1:0.7,spin2:0.6,sep:20}
};

let presetState = { name:null, params:null, ts:null, playing:false, startTime:0, raf:null, trails:{bh1:[], bh2:[]}, audio:{enabled:false, ctx:null, osc:null} };
let customState = { name:null, params:null, ts:null, playing:false, startTime:0, raf:null, trails:{bh1:[], bh2:[]}, audio:{enabled:false, ctx:null, osc:null} };

/* play loop for a given state (preset or custom) and orbit element id */
function playState(state, orbitElId, waveElId, specElId, energyElId){
  if(!state.ts) return;
  state.playing = true;
  state.startTime = performance.now();
  if(state.audio.enabled && !state.audio.ctx) state.audio.ctx = new (window.AudioContext||window.webkitAudioContext)();
  if(state.audio.enabled && state.audio.ctx && !state.audio.osc){
    const osc = state.audio.ctx.createOscillator();
    const gain = state.audio.ctx.createGain(); gain.gain.value = 0.04;
    osc.type='sine'; osc.connect(gain); gain.connect(state.audio.ctx.destination); osc.start();
    state.audio.osc = {osc,gain};
  }

  function step(){
    if(!state.playing){ state.raf = null; return; }
    const elapsed = (performance.now() - state.startTime)/1000;
    const frac = elapsed / state.ts.duration;
    const idx = Math.floor(frac * (state.ts.t.length - 1));
    if(idx >= state.ts.t.length - 1){
      state.playing = false;
      if(state.audio.osc){ try{ state.audio.osc.osc.stop(); }catch(e){} state.audio.osc=null; }
      state.raf = null;
      return;
    }
    const pos = computePositions(idx, state.ts, state.params);
    const maxTrail = Number(document.getElementById('trailLen').value) || 40;
    const perBH = Math.max(4, Math.round(maxTrail/6));
    pushTrail(state.trails.bh1, pos.bh1, perBH); pushTrail(state.trails.bh2, pos.bh2, perBH);
    const pts1 = trailToPoints(state.trails.bh1, [255,160,64]).slice(-perBH);
    const pts2 = trailToPoints(state.trails.bh2, [0,212,255]).slice(-perBH);
    const trailPts = pts1.concat(pts2).slice(-maxTrail);
    updateOrbit(orbitElId, pos.bh1, pos.bh2, trailPts);
    if(state.audio.enabled && state.audio.osc && state.ts.freq[idx]){
      const aud = Math.min(2000, 80 + state.ts.freq[idx] * 1.1);
      try{ state.audio.osc.osc.frequency.setValueAtTime(aud, state.audio.ctx.currentTime); }catch(e){}
    }
    state.raf = requestAnimationFrame(step);
  }
  if(!state.raf) state.raf = requestAnimationFrame(step);
}

function pauseState(state){
  state.playing = false;
  if(state.audio.osc){ try{ state.audio.osc.osc.stop(); }catch(e){} state.audio.osc = null; }
  if(state.raf){ cancelAnimationFrame(state.raf); state.raf = null; }
}

/* start/sync functions */
function startPreset(key){
  const params = Object.assign({}, PRESETS[key]);
  const ts = generateChirp(params);
  presetState.name = key; presetState.params = params; presetState.ts = ts;
  presetState.trails.bh1 = []; presetState.trails.bh2 = [];
  // plots
  plotWave('presetWave', ts, `${key} — waveform`);
  plotSpec('presetSpec', ts, `${key} — spectrogram`);
  plotEnergy('presetEnergy', ts);
  // init orbit
  const p = computePositions(0, ts, params);
  updateOrbit('presetOrbit', p.bh1, p.bh2, []);
  pauseState(presetState);
}

function startCustom(params){
  const ts = generateChirp(params);
  customState.name = 'Custom'; customState.params = params; customState.ts = ts;
  customState.trails.bh1 = []; customState.trails.bh2 = [];
  plotWave('customWave', ts, `Custom — waveform`);
  plotSpec('customSpec', ts, `Custom — spectrogram`);
  plotEnergy('customEnergy', ts);
  const p = computePositions(0, ts, params);
  updateOrbit('customOrbit', p.bh1, p.bh2, []);
  pauseState(customState);
}

/* ============================
 Export helpers (JSON + ZIP)
 ============================ */
async function exportPackageForState(state, filenamePrefix){
  if(!state.ts || !state.params){ alert('Run simulation first'); return; }
  const zip = new JSZip();
  zip.file('params.json', JSON.stringify(state.params, null, 2));
  // waveform csv
  let csv = 'time,strain\n';
  for(let i=0;i<state.ts.t.length;i++) csv += `${state.ts.t[i]},${state.ts.h[i]}\n`;
  zip.file('waveform.csv', csv);
  // metadata
  const meta = { simulation: state.name || 'sim', duration: state.ts.duration, samples: state.ts.t.length, created: new Date().toISOString() };
  zip.file('metadata.json', JSON.stringify(meta, null, 2));
  // capture waveform png (try)
  try{
    const dataUrl = await Plotly.toImage(document.getElementById(state===presetState? 'presetWave':'customWave'), {format:'png', width:1200, height:400});
    const blob = await (await fetch(dataUrl)).blob();
    const arr = await blob.arrayBuffer();
    zip.file('waveform.png', arr);
  }catch(e){ console.warn('Could not capture waveform image:', e); }
  const content = await zip.generateAsync({type:'blob'});
  downloadBlob(content, `${filenamePrefix}_package.zip`);
}
function exportParamsJSONForState(state, filename){
  if(!state.params){ alert('Run simulation first'); return; }
  const blob = new Blob([JSON.stringify(state.params, null, 2)], {type:'application/json'});
  downloadBlob(blob, filename);
}

/* ============================
 UI Wiring
 ============================ */
/* Tabs */
document.getElementById('tabPreset').addEventListener('click', ()=>{
  document.getElementById('presetCard').style.display='block';
  document.getElementById('customCard').style.display='none';
  document.getElementById('tabPreset').classList.add('active');
  document.getElementById('tabCustom').classList.remove('active');
});
document.getElementById('tabCustom').addEventListener('click', ()=>{
  document.getElementById('presetCard').style.display='none';
  document.getElementById('customCard').style.display='block';
  document.getElementById('tabCustom').classList.add('active');
  document.getElementById('tabPreset').classList.remove('active');
});

/* About modal */
document.getElementById('aboutBtn').addEventListener('click', ()=>{
  const m=document.getElementById('aboutModal'); m.style.display = m.style.display==='block'?'none':'block';
});
document.getElementById('aboutClose').addEventListener('click', ()=>{ document.getElementById('aboutModal').style.display='none'; });

/* Preset run + controls */
document.getElementById('presetRun').addEventListener('click', ()=>{
  const key = document.getElementById('presetEventSelect').value || 'GW150914';
  startPreset(key);
});
document.getElementById('presetPlay').addEventListener('click', ()=>{ playState(presetState, 'presetOrbit', 'presetWave', 'presetSpec', 'presetEnergy'); });
document.getElementById('presetPause').addEventListener('click', ()=>{ pauseState(presetState); });
document.getElementById('presetRestart').addEventListener('click', ()=>{
  if(!presetState.params) return; startPreset(presetState.name); playState(presetState, 'presetOrbit', 'presetWave', 'presetSpec', 'presetEnergy');
});
document.getElementById('presetSound').addEventListener('click', ()=>{
  presetState.audio.enabled = !presetState.audio.enabled;
  document.getElementById('presetSound').textContent = presetState.audio.enabled ? 'Disable Sound' : 'Enable Sound';
});

/* Preset export */
document.getElementById('presetExportJSON').addEventListener('click', ()=>{ exportParamsJSONForState(presetState, `${(presetState.name||'preset')}_params.json`); });
document.getElementById('presetExportZIP').addEventListener('click', ()=>{ exportPackageForState(presetState, (presetState.name||'preset')); });

/* Custom run + controls */
document.getElementById('customRun').addEventListener('click', ()=>{
  const params = {
    m1: parseFloat(document.getElementById('c_m1').value) || 36,
    m2: parseFloat(document.getElementById('c_m2').value) || 29,
    spin1: parseFloat(document.getElementById('c_s1').value) || 0,
    spin2: parseFloat(document.getElementById('c_s2').value) || 0,
    sep: parseFloat(document.getElementById('c_sep').value) || 15
  };
  startCustom(params);
});
document.getElementById('customPlay').addEventListener('click', ()=>{ playState(customState, 'customOrbit', 'customWave', 'customSpec', 'customEnergy'); });
document.getElementById('customPause').addEventListener('click', ()=>{ pauseState(customState); });
document.getElementById('customRestart').addEventListener('click', ()=>{ if(!customState.params) return; startCustom(customState.params); playState(customState, 'customOrbit', 'customWave', 'customSpec', 'customEnergy'); });
document.getElementById('customSound').addEventListener('click', ()=>{ customState.audio.enabled = !customState.audio.enabled; document.getElementById('customSound').textContent = customState.audio.enabled ? 'Disable Sound' : 'Enable Sound'; });

/* Custom export */
document.getElementById('customExportJSON').addEventListener('click', ()=>{ exportParamsJSONForState(customState, `custom_params.json`); });
document.getElementById('customExportZIP').addEventListener('click', ()=>{ exportPackageForState(customState, 'custom'); });

/* Trail length display */
document.getElementById('trailLen').addEventListener('input',(e)=>{ document.getElementById('trailVal').textContent = e.target.value; });

/* Initialize defaults */
(function init(){
  document.getElementById('presetEventSelect').value = 'GW150914';
  startPreset('GW150914');
  // default custom
  const defaultCustom = { m1:36,m2:29,spin1:0.3,spin2:0.2,sep:15 };
  document.getElementById('c_m1').value = defaultCustom.m1;
  document.getElementById('c_m2').value = defaultCustom.m2;
  document.getElementById('c_s1').value = defaultCustom.spin1;
  document.getElementById('c_s2').value = defaultCustom.spin2;
  document.getElementById('c_sep').value = defaultCustom.sep;
  startCustom(defaultCustom);
  // resize
  setTimeout(()=>{ ['presetOrbit','customOrbit','presetWave','presetSpec','customWave','customSpec'].forEach(id=>{ const el=document.getElementById(id); if(el && el.data) Plotly.Plots.resize(el); }); }, 300);
})();

/* responsive resize */
window.addEventListener('resize', ()=>{ ['presetOrbit','customOrbit','presetWave','presetSpec','customWave','customSpec'].forEach(id=>{ const el=document.getElementById(id); if(el && el.data) Plotly.Plots.resize(el); }); });
</script>
</body>
</html>
