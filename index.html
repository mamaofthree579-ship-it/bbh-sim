<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open Gravitational Wave Explorer ‚Äî Fixed</title>

  <!-- Plotly CDN (keeps file light) -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    :root{ --bg:#02030a; --panel:#0d0d20; --accent:#00aaff; --muted:#9aa; --text:#fff; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; background:radial-gradient(circle,#02030a 10%, #000 100%);color:var(--text)}
    header{text-align:center;padding:1rem;border-bottom:1px solid rgba(255,255,255,0.04)}
    h1{margin:0;font-size:1.4rem;color:var(--accent)}
    .controls{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center;padding:12px}
    select, button, input[type="range"]{background:#0a0a20;color:#fff;border:1px solid #333;border-radius:8px;padding:.45rem .7rem}
    button{cursor:pointer}
    #chart{width:92%;max-width:900px;margin:12px auto;background:var(--panel);padding:10px;border-radius:10px}
    #playChirpBtn{display:block;margin:12px auto 28px auto;padding:.5rem 1rem;background:var(--accent);border:none;border-radius:8px;color:#000;font-weight:700}
    #customControls{width:92%;max-width:900px;margin:8px auto;padding:10px;background:rgba(255,255,255,0.02);border-radius:10px;display:none}
    .control-row{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .control-row label{min-width:110px;text-align:right}
    .small{font-size:0.9rem;color:var(--muted)}
    footer{text-align:center;padding:14px;color:var(--muted)}

    /* modal */
    #infoModal{display:none;opacity:0;position:fixed;inset:0;background:rgba(0,0,0,0.75);align-items:center;justify-content:center;z-index:60;transition:opacity .3s}
    #infoModal.show{display:flex;opacity:1}
    .modal-content{background:#111;padding:20px;border-radius:12px;max-width:700px;position:relative;color:#eaeaea;transform:scale(.98);transition:transform .25s}
    #infoModal.show .modal-content{transform:scale(1)}
    .close{position:absolute;right:12px;top:8px;cursor:pointer;font-size:1.4rem;color:#bbb}
    .learn-btn{margin-top:12px;padding:.5rem 1rem;background:#003366;border:1px solid #00aaff;color:#fff;border-radius:8px;cursor:pointer}

    /* learn panel */
    #learnPanel{position:fixed;left:0;right:0;bottom:-100%;background:#050510;border-top:3px solid var(--accent);padding:12px;z-index:70;transition:bottom .35s}
    #learnPanel.show{bottom:0}
    #orbitCanvas{background:#000;display:block;margin:8px auto;border-radius:6px}
    @media(min-width:900px){ #chart{padding:18px} }
  </style>
</head>
<body>
  <header>
    <h1>Open Gravitational Wave Explorer</h1>
    <div class="small">Fixed UI ‚Äî Play button visible, custom controls robust, no stray drawing</div>
  </header>

  <div class="controls" role="region" aria-label="controls">
    <label for="eventSelect" class="small">Event:</label>
    <select id="eventSelect" aria-label="Event select">
      <option value="gw150914">GW150914 ‚Äî First LIGO</option>
      <option value="gw170104">GW170104</option>
      <option value="gw190521">GW190521</option>
      <option value="custom">Custom Simulation</option>
    </select>

    <button id="simulateBtn">Simulate</button>
    <button id="infoBtn">‚ÑπÔ∏è Info</button>
  </div>

  <!-- custom controls -->
  <div id="customControls" aria-hidden="true">
    <div class="control-row">
      <label for="m1Slider">M‚ÇÅ (M‚òâ)</label>
      <input id="m1Slider" type="range" min="5" max="80" value="30">
      <span id="m1Val" class="small">30</span>
    </div>
    <div class="control-row">
      <label for="m2Slider">M‚ÇÇ (M‚òâ)</label>
      <input id="m2Slider" type="range" min="5" max="80" value="25">
      <span id="m2Val" class="small">25</span>
    </div>
    <div class="control-row">
      <label for="s1Slider">Spin‚ÇÅ</label>
      <input id="s1Slider" type="range" min="0" max="1" step="0.01" value="0.3">
      <span id="s1Val" class="small">0.30</span>
    </div>
    <div class="control-row">
      <label for="s2Slider">Spin‚ÇÇ</label>
      <input id="s2Slider" type="range" min="0" max="1" step="0.01" value="0.20">
      <span id="s2Val" class="small">0.20</span>
    </div>
  </div>

  <!-- Plot container -->
  <div id="chart" role="img" aria-label="waveform chart"></div>

  <!-- Play button (guaranteed visible) -->
  <button id="playChirpBtn" aria-label="Play chirp sound">üîä Play Chirp</button>

  <!-- Info Modal -->
  <div id="infoModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-content">
      <span id="closeInfo" class="close" title="Close">√ó</span>
      <h2>Understanding gravitational waves</h2>
      <p><strong>Strain (h):</strong> fractional change in distance measured by detectors.</p>
      <p><strong>Chirp mass:</strong> sets how fast the frequency increases.</p>
      <p><strong>Spins:</strong> change inspiral speed and waveform phase.</p>
      <button id="learnMoreBtn" class="learn-btn">üìñ Learn More</button>
    </div>
  </div>

  <!-- Learn panel (orbit + small waveform) -->
  <div id="learnPanel" aria-hidden="true">
    <h3>Chirp mass & orbit demo</h3>
    <canvas id="orbitCanvas" width="320" height="200"></canvas>
    <div style="margin-top:.6rem">
      <button id="closeLearn" class="learn-btn">Close</button>
    </div>
  </div>

  <footer>Open BBH Simulation ‚Ä¢ demo</footer>

<script>
/* Single consolidated DOMContentLoaded handler - no global errors */
document.addEventListener('DOMContentLoaded', () => {

  // DOM references
  const eventSelect = document.getElementById('eventSelect');
  const simulateBtn = document.getElementById('simulateBtn');
  const infoBtn = document.getElementById('infoBtn');
  const infoModal = document.getElementById('infoModal');
  const closeInfo = document.getElementById('closeInfo');
  const learnMoreBtn = document.getElementById('learnMoreBtn');
  const learnPanel = document.getElementById('learnPanel');
  const closeLearn = document.getElementById('closeLearn');
  const customControls = document.getElementById('customControls');

  // sliders + labels (explicit variables so generateWaveform can reference)
  const m1Slider = document.getElementById('m1Slider');
  const m2Slider = document.getElementById('m2Slider');
  const s1Slider = document.getElementById('s1Slider');
  const s2Slider = document.getElementById('s2Slider');
  const m1Val = document.getElementById('m1Val');
  const m2Val = document.getElementById('m2Val');
  const s1Val = document.getElementById('s1Val');
  const s2Val = document.getElementById('s2Val');

  const chartDiv = document.getElementById('chart');
  const playChirpBtn = document.getElementById('playChirpBtn');

  // update slider labels
  function updateLabels(){
    m1Val.textContent = m1Slider.value;
    m2Val.textContent = m2Slider.value;
    s1Val.textContent = parseFloat(s1Slider.value).toFixed(2);
    s2Val.textContent = parseFloat(s2Slider.value).toFixed(2);
  }
  [m1Slider, m2Slider, s1Slider, s2Slider].forEach(s => s.addEventListener('input', updateLabels));
  updateLabels();

  // Modal controls (robust)
  infoModal.style.display = 'none';
  infoBtn.addEventListener('click', () => {
    infoModal.style.display = 'flex';
    infoModal.classList.add('show');
    infoModal.setAttribute('aria-hidden','false');
  });
  function closeModal(){
    infoModal.classList.remove('show');
    setTimeout(()=>{ infoModal.style.display='none'; infoModal.setAttribute('aria-hidden','true'); }, 300);
  }
  closeInfo.addEventListener('click', closeModal);
  infoModal.addEventListener('click', (e)=>{ if(e.target===infoModal) closeModal(); });

  // Learn panel controls
  learnMoreBtn.addEventListener('click', ()=> {
    learnPanel.classList.add('show');
    startOrbitAnimation();
    playChirpSound(); // also play chirp for the demo
  });
  closeLearn.addEventListener('click', ()=> learnPanel.classList.remove('show'));

  // show/hide custom controls when user picks custom
  function checkCustomVisibility(){
    if(eventSelect.value === 'custom'){
      customControls.style.display = 'block';
      customControls.setAttribute('aria-hidden','false');
    } else {
      customControls.style.display = 'none';
      customControls.setAttribute('aria-hidden','true');
    }
  }
  eventSelect.addEventListener('change', checkCustomVisibility);
  // initial check (fixes issue where custom wasn't shown)
  checkCustomVisibility();

  // Core waveform generator (safe: no undefined variables)
  function generateWaveform(choice){
    let freq, decay, label;
    if(choice === 'custom'){
      const m1 = Number(m1Slider.value);
      const m2 = Number(m2Slider.value);
      const s1 = Number(s1Slider.value);
      const s2 = Number(s2Slider.value);
      // chirp-mass-like scaling (toy model)
      const chirpMass = Math.pow((m1*m2), 3/5) / Math.pow(m1+m2, 1/5);
      freq = 0.1 + (50 / Math.max(1, chirpMass)) * 0.002; // avoid div by zero
      decay = 0.001 + (s1 + s2) * 0.001;
      label = `Custom ‚Äî M‚ÇÅ=${m1} M‚òâ, M‚ÇÇ=${m2} M‚òâ`;
    } else {
      // presets tuned for demo
      customControls.style.display = 'none';
      if(choice === 'gw150914'){ freq = 0.25; decay = 0.002; label = 'GW150914'; }
      else if(choice === 'gw170104'){ freq = 0.18; decay = 0.0018; label = 'GW170104'; }
      else if(choice === 'gw190521'){ freq = 0.12; decay = 0.001; label = 'GW190521'; }
      else { freq = 0.2; decay = 0.0015; label = 'Demo'; }
    }

    // build data and plot with Plotly
    const N = 2000;
    const t = new Array(N);
    const hPlus = new Array(N);
    const hCross = new Array(N);
    for(let i=0;i<N;i++){
      const x = i/20; // time index scaled
      t[i]=x;
      hPlus[i]=Math.sin(freq*x)*Math.exp(-decay*x);
      hCross[i]=Math.cos(freq*x)*Math.exp(-decay*x);
    }

    const traces = [
      { x: t, y: hPlus, mode: 'lines', name: 'h‚Çä', line:{width:2, color:'#00e5ff'} },
      { x: t, y: hCross, mode: 'lines', name: 'h√ó', line:{width:2, color:'#ff66cc'} }
    ];
    const layout = {
      title: `${label} ‚Äî Simulated Strain (toy model)`,
      xaxis:{title:'Time (M)'},
      yaxis:{title:'Strain (arb units)'},
      paper_bgcolor: 'transparent',
      plot_bgcolor: 'transparent',
      font:{color:'#ddd'}
    };
    Plotly.newPlot(chartDiv, traces, layout, {responsive:true, displayModeBar:false});
  }

  // Simulate button
  simulateBtn.addEventListener('click', ()=> generateWaveform(eventSelect.value) );

  // initial plot
  generateWaveform(eventSelect.value);

  // Play chirp (general-purpose) ‚Äî uses small WebAudio sweep
  function playChirpSound(opts){
    try{
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.connect(gain); gain.connect(audioCtx.destination);

      // allow override via opts
      const duration = (opts && opts.duration) ? opts.duration : 2.8;
      const startFreq = (opts && opts.startFreq) ? opts.startFreq : 120;
      const endFreq = (opts && opts.endFreq) ? opts.endFreq : 900;

      const now = audioCtx.currentTime;
      osc.frequency.setValueAtTime(startFreq, now);
      // use linear ramp to avoid errors on some browsers when start==end
      osc.frequency.exponentialRampToValueAtTime(Math.max(1,endFreq), now + duration);
      gain.gain.setValueAtTime(0.08, now);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

      osc.start(now); osc.stop(now + duration);
    }catch(e){ console.warn('Audio failed:', e); }
  }

  // Play Chirp button wired
  playChirpBtn.addEventListener('click', ()=> {
    // small heuristic: if custom selected, make chirp lower/faster by masses
    if(eventSelect.value === 'custom'){
      const m1 = Number(m1Slider.value), m2 = Number(m2Slider.value);
      // heavier => lower pitch
      const chirpMass = Math.pow((m1*m2),3/5)/Math.pow(m1+m2,1/5);
      const start = Math.max(40, 100 - chirpMass*0.6);
      const end = Math.max(200, 1000 - chirpMass*3);
      playChirpSound({duration:3, startFreq:start, endFreq:end});
    } else {
      playChirpSound({duration:3, startFreq:120, endFreq:800});
    }
  });

  // Orbit animation (Learn panel)
  function startOrbitAnimation(){
    const canvas = document.getElementById('orbitCanvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    let angle = 0;
    let running = true;
    // stop previous loops by using closure flag
    (function loop(){
      if(!document.body.contains(canvas)) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const cx = canvas.width/2, cy = canvas.height/2, r = 60;
      const x1 = cx + r*Math.cos(angle), y1 = cy + r*Math.sin(angle);
      const x2 = cx - r*Math.cos(angle), y2 = cy - r*Math.sin(angle);
      // orbit tracks
      ctx.fillStyle = '#002233';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.beginPath();
      ctx.fillStyle = '#00aaff';
      ctx.arc(x1,y1,10,0,Math.PI*2);
      ctx.arc(x2,y2,10,0,Math.PI*2);
      ctx.fill();
      angle += 0.06;
      requestAnimationFrame(loop);
    })();
  }

}); // end DOMContentLoaded
</script>
</body>
</html>
