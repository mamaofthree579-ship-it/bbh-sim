<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BBH Simulator ‚Äî Overview & Events (Compare A/B)</title>
<style>
  :root{
    --bg:#05000a; --panel:#1a001f; --accent:#8000ff; --muted:#33003d; --text:#e5ccff;
  }
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
  .tabs{display:flex;background:var(--panel);border-bottom:2px solid var(--muted);}
  .tabButton{flex:1;padding:12px;cursor:pointer;background:transparent;border:0;color:var(--text);font-weight:700}
  .tabButton.active{background:var(--accent);color:#fff}
  .container{padding:18px}
  h2{margin:6px 0 10px;color:var(--text)}
  canvas{display:block;margin:12px auto;border-radius:8px;background:radial-gradient(circle at center,#14001a 0%, #05000a 100%);box-shadow:0 6px 18px rgba(0,0,0,0.6);}
  label,input,select,button,textarea{margin:6px 6px 6px 0;padding:8px;border-radius:6px;border:none}
  .panel{background:rgba(30,0,40,0.6);padding:12px;border-radius:10px;border:1px solid var(--muted);max-width:1180px;margin:12px auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:0.9rem;color:#d6c7ff}
  .muted{color:#bdaeff}
  .btn{background:var(--accent);border-radius:6px;color:white;padding:8px 12px;border:0;cursor:pointer}
  .btn.secondary{background:#444}
  .legend{display:flex;gap:16px;align-items:center;justify-content:center;margin-top:8px;color:var(--text);font-size:0.95rem}
  .swatch{width:18px;height:10px;border-radius:4px;display:inline-block;margin-right:6px;vertical-align:middle;cursor:pointer; border:1px solid rgba(255,255,255,0.06)}
  .tooltip { position: absolute; background: rgba(20,10,30,0.95); color: #fff; padding:8px; border-radius:6px; border:1px solid rgba(120,90,200,0.25); max-width:420px; font-size:0.95rem; display:none; z-index:1000; }
  pre { background:#070018; padding:8px; border-radius:6px; overflow:auto; color:#f0f0ff; }
  table { width:100%; border-collapse:collapse; }
  table td, table th { padding:6px; border-bottom:1px solid rgba(255,255,255,0.04); color:var(--text) }
  .smallMuted { font-size:0.85rem; color:#cfc3ff; margin-top:6px; }
  .split { display:flex; gap:12px; align-items:flex-start; }
  .col { flex:1; min-width:300px; }
  .panel-head { display:flex; gap:8px; align-items:center; justify-content:space-between; }
  .label-pill { background: rgba(255,255,255,0.04); padding:6px 8px; border-radius:6px; font-weight:600; color:var(--text) }
</style>
</head>
<body>

<!-- Tabs -->
<div class="tabs">
  <button class="tabButton active" data-tab="overviewTab">Overview</button>
  <button class="tabButton" data-tab="eventsTab">Events (Compare A/B)</button>
  <button class="tabButton" data-tab="calculatorsTab">Calculators</button>
</div>

<!-- Overview Tab -->
<div id="overviewTab" class="container tabContent" style="display:block">
  <h2>üåå Black Hole Overview ‚Äî Sagittarius A*</h2>
  <div class="panel">
    <p class="small">Sagittarius A* visualization. Hover legend to read quick notes. Calculator is below the visual.</p>
    <canvas id="bhCanvas" width="920" height="420"></canvas>

    <div class="legend" aria-hidden="true">
      <div data-tooltip="eh"><span class="swatch" style="background:rgba(140,80,255,0.35);"></span>Event Horizon</div>
      <div data-tooltip="ad"><span class="swatch" style="background:rgba(255,180,80,0.22);"></span>Accretion Disk</div>
      <div data-tooltip="jet"><span class="swatch" style="background:rgba(120,200,255,0.18);"></span>Relativistic Jet</div>
    </div>
  </div>

  <div class="panel" id="sgrCalcPanel">
    <div class="panel-head">
      <strong>Sagittarius A* ‚Äî quick calculator</strong>
      <div class="label-pill">Used for rough time-dilation / decay examples</div>
    </div>

    <div class="row" style="margin-top:8px">
      <label>Radius r (m)</label>
      <input id="radiusInput" type="number" value="7.8e17" style="width:260px">
      <label>Dark Matter œÅ_DM (kg/m¬≥)</label>
      <input id="densityInput" type="number" value="1e-21" style="width:220px">
      <button id="runCalcBtn" class="btn">Run</button>
    </div>
    <div id="calcResults" style="margin-top:8px;color:#ffd;"></div>
  </div>
</div>

<!-- Events Tab (side-by-side A/B) -->
<div id="eventsTab" class="container tabContent" style="display:none">
  <h2>üí´ Gravitational-Wave Events ‚Äî Side-by-side Compare</h2>

  <div class="panel">
    <div class="row">
      <div class="label-pill">Panel A</div>
      <div class="label-pill">Panel B</div>
      <div style="margin-left:auto" class="smallMuted">Select events on each side ‚Äî run them independently.</div>
    </div>

    <div class="split" style="margin-top:10px;">
      <!-- Column A -->
      <div class="col panel" id="panelA">
        <div class="row">
          <div>
            <label for="eventA">Event A</label>
            <select id="eventA"></select>
          </div>
          <div>
            <button id="runA" class="btn">Run Simulation (A)</button>
            <button id="resetA" class="btn secondary">Reset (A)</button>
          </div>
          <div style="margin-left:auto">
            <button id="playA" class="btn">üîä Play A</button>
            <button id="stopA" class="btn secondary">‚èπ Stop</button>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <label>M‚ÇÅ</label><input id="m1A" type="number" value="30" step="0.1" style="width:80px">
          <label>M‚ÇÇ</label><input id="m2A" type="number" value="30" step="0.1" style="width:80px">
          <label>Spin</label><input id="spinA" type="range" min="0" max="1" step="0.01" value="0.5" style="width:140px">
          <span id="spinValA" class="muted">0.50</span>
        </div>

        <canvas id="orbitA" width="440" height="300"></canvas>
        <canvas id="chirpA" width="440" height="110"></canvas>

        <div style="margin-top:8px;background:rgba(10,0,20,0.6);padding:8px;border-radius:6px;border:1px solid var(--muted)">
          <strong>Event A Info</strong>
          <table>
            <tr><td class="smallMuted">Name</td><td id="nameA" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Chirp mass</td><td id="cmA" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Freq range</td><td id="frA" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Estimated h</td><td id="hA" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Distance est.</td><td id="dA" style="text-align:right">‚Äî</td></tr>
          </table>
        </div>
      </div>

      <!-- Column B -->
      <div class="col panel" id="panelB">
        <div class="row">
          <div>
            <label for="eventB">Event B</label>
            <select id="eventB"></select>
          </div>
          <div>
            <button id="runB" class="btn">Run Simulation (B)</button>
            <button id="resetB" class="btn secondary">Reset (B)</button>
          </div>
          <div style="margin-left:auto">
            <button id="playB" class="btn">üîä Play B</button>
            <button id="stopB" class="btn secondary">‚èπ Stop</button>
          </div>
        </div>

        <div class="row" style="margin-top:6px">
          <label>M‚ÇÅ</label><input id="m1B" type="number" value="30" step="0.1" style="width:80px">
          <label>M‚ÇÇ</label><input id="m2B" type="number" value="30" step="0.1" style="width:80px">
          <label>Spin</label><input id="spinB" type="range" min="0" max="1" step="0.01" value="0.5" style="width:140px">
          <span id="spinValB" class="muted">0.50</span>
        </div>

        <canvas id="orbitB" width="440" height="300"></canvas>
        <canvas id="chirpB" width="440" height="110"></canvas>

        <div style="margin-top:8px;background:rgba(10,0,20,0.6);padding:8px;border-radius:6px;border:1px solid var(--muted)">
          <strong>Event B Info</strong>
          <table>
            <tr><td class="smallMuted">Name</td><td id="nameB" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Chirp mass</td><td id="cmB" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Freq range</td><td id="frB" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Estimated h</td><td id="hB" style="text-align:right">‚Äî</td></tr>
            <tr><td class="smallMuted">Distance est.</td><td id="dB" style="text-align:right">‚Äî</td></tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Shared visual summaries (below both panels) -->
    <div style="margin-top:12px" class="panel">
      <strong>Scientific Summary (both)</strong>
      <div class="row">
        <canvas id="ampBoth" width="920" height="110"></canvas>
      </div>
      <div class="smallMuted">Use these graphs to compare amplitude/frequency envelopes across A/B.</div>
    </div>
  </div>
</div>

<!-- Calculators Tab -->
<div id="calculatorsTab" class="container tabContent" style="display:none">
  <h2>üßÆ Calculators</h2>
  <div class="panel">
    <p class="small">Advanced calculators can be added here. For now, use the Sgr A* quick calculator on the Overview tab.</p>
  </div>
</div>

<!-- Tooltip DOM -->
<div id="tooltip" class="tooltip" role="dialog" aria-hidden="true"></div>

<script>
/* -----------------------
   Basic tabs wiring
   ----------------------- */
document.querySelectorAll('.tabButton').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabButton').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tabContent').forEach(c=>c.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
    tooltip.style.display='none';
  });
});

/* -----------------------
   Overview: BH visuals + trail + stars (kept as before)
   ----------------------- */
const bhCanvas = document.getElementById('bhCanvas');
const bhCtx = bhCanvas.getContext('2d');
const bhW = bhCanvas.width, bhH = bhCanvas.height;
const bhCx = bhW/2, bhCy = bhH/2;
const horizonR = 70;
const stars = Array.from({length:160}, ()=>({x:Math.random()*bhW,y:Math.random()*bhH,r:0.5+Math.random()*1.1,phi:Math.random()*Math.PI*2,vx:(Math.random()-0.5)*0.06}));
let bhHotAngle = 0;

function drawOverview(){
  bhCtx.clearRect(0,0,bhW,bhH);
  const g = bhCtx.createRadialGradient(bhCx,bhCy,10,bhCx,bhCy,300);
  g.addColorStop(0,'#070012'); g.addColorStop(1,'#010006');
  bhCtx.fillStyle=g; bhCtx.fillRect(0,0,bhW,bhH);

  // stars not inside horizon
  for(const s of stars){
    s.phi += 0.02 + Math.random()*0.01;
    s.x += s.vx; if(s.x < -2) s.x = bhW + 2; if(s.x > bhW+2) s.x = -2;
    const d = Math.hypot(s.x-bhCx, s.y-bhCy);
    if(d > horizonR + 12){
      bhCtx.beginPath();
      bhCtx.fillStyle = `rgba(255,255,255,${0.45 + 0.5*Math.sin(s.phi)})`;
      bhCtx.arc(s.x,s.y,s.r,0,Math.PI*2); bhCtx.fill();
    }
  }

  // accretion disk
  for(let i=0;i<40;i++){
    bhCtx.beginPath();
    bhCtx.arc(bhCx,bhCy,horizonR+8 + i*3,0,Math.PI*2);
    bhCtx.strokeStyle = `rgba(255,180,80,${0.006 + i*0.0006})`;
    bhCtx.stroke();
  }

  // event horizon
  bhCtx.beginPath(); bhCtx.arc(bhCx,bhCy,horizonR,0,Math.PI*2);
  bhCtx.strokeStyle='rgba(140,80,255,0.35)'; bhCtx.lineWidth=2; bhCtx.stroke();

  // jet
  bhCtx.fillStyle='rgba(120,200,255,0.06)';
  bhCtx.fillRect(bhCx-6, 0, 12, bhCy-120);

  // central fill
  bhCtx.beginPath(); bhCtx.arc(bhCx,bhCy,horizonR,0,Math.PI*2); bhCtx.fillStyle='black'; bhCtx.fill();

  // hotspot + short trail
  const hx = bhCx + Math.cos(bhHotAngle) * 110;
  const hy = bhCy + Math.sin(bhHotAngle) * 34;
  for(let k=0;k<10;k++){
    const t = bhHotAngle - k*0.12;
    const tx = bhCx + Math.cos(t)*(110 - k*6);
    const ty = bhCy + Math.sin(t)*(34 - k*2);
    bhCtx.beginPath(); bhCtx.arc(tx,ty,4 - k*0.28,0,Math.PI*2);
    bhCtx.fillStyle = `rgba(255,220,180,${0.09*(10-k)})`; bhCtx.fill();
  }
  bhCtx.beginPath(); bhCtx.arc(hx,hy,6,0,Math.PI*2); bhCtx.fillStyle='#ffcc99'; bhCtx.fill();

  bhHotAngle += 0.026;
  requestAnimationFrame(drawOverview);
}
drawOverview();

/* legend tooltip wiring */
const tooltip = document.getElementById('tooltip');
const tooltipData = {
  "eh":"Event horizon ‚Äî radius where escape speed = c. r_s = 2GM/c¬≤",
  "ad":"Accretion disk ‚Äî hot gas orbiting and radiating; viscous processes drive accretion.",
  "jet":"Relativistic jet ‚Äî collimated outflow sometimes powered by BH spin."
};
document.querySelectorAll('.legend div').forEach(div=>{
  const key = div.getAttribute('data-tooltip');
  div.addEventListener('mouseenter', (e)=>{
    tooltip.textContent = tooltipData[key] || '';
    tooltip.style.left = (e.clientX + 12) + 'px';
    tooltip.style.top = (e.clientY + 12) + 'px';
    tooltip.style.display='block';
  });
  div.addEventListener('mousemove', (e)=>{ tooltip.style.left=(e.clientX+12)+'px'; tooltip.style.top=(e.clientY+12)+'px';});
  div.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; });
});

/* Sgr A* calculator (overview) */
document.getElementById('runCalcBtn').addEventListener('click', ()=>{
  const G=6.67430e-11, M=4.3e6*1.989e30, c=3e8;
  const r = Number(document.getElementById('radiusInput').value) || 7.8e17;
  const rho = Number(document.getElementById('densityInput').value) || 1e-21;
  const val = 1 - (G*M)/(r*c*c);
  const gamma = val>0 ? Math.sqrt(val) : 0;
  const alpha = 1e21;
  const Gamma_dark = 1*(1 + alpha*rho);
  document.getElementById('calcResults').innerHTML = `<div>Œ≥ = <strong>${gamma.toFixed(6)}</strong> &nbsp; | &nbsp; Œì_dark ‚âà <strong>${Gamma_dark.toExponential(2)}</strong></div>`;
});

/* -----------------------
   Events DB (expanded set)
   ----------------------- */
const EVENTS = {
  "GW150914": { m1:36, m2:29, spin:0.3, color:'#a64dff', desc:'GW150914 ‚Äî first detection (2015): 36 + 29 M‚òâ.' },
  "GW170104": { m1:31, m2:19, spin:0.45, color:'#00ccff', desc:'GW170104 ‚Äî 31 + 19 M‚òâ.' },
  "GW170608": { m1:12, m2:7, spin:0.25, color:'#66ff99', desc:'GW170608 ‚Äî 12 + 7 M‚òâ.' },
  "GW190521": { m1:85, m2:66, spin:0.7, color:'#ff9933', desc:'GW190521 ‚Äî 85 + 66 M‚òâ.' },
  "GW190814": { m1:23, m2:2.6, spin:0.05, color:'#ffcc00', desc:'GW190814 ‚Äî 23 + 2.6 M‚òâ (BH+compact?)' },
  "GW200115": { m1:6, m2:1.5, spin:0.2, color:'#33aaff', desc:'GW200115 ‚Äî NS‚ÄìBH candidate.' },
  "Custom":    { m1:30, m2:30, spin:0.5, color:'#ffd166', desc:'Custom system.' }
};

/* populate both selectors */
const selA = document.getElementById('eventA');
const selB = document.getElementById('eventB');
for(const k in EVENTS){
  const oA = document.createElement('option'); oA.value=k; oA.textContent=k; selA.appendChild(oA);
  const oB = document.createElement('option'); oB.value=k; oB.textContent=k; selB.appendChild(oB);
}

/* -----------------------
   Shared: waveform generation function (toy PN-like)
   ----------------------- */
function generateWaveform(m1,m2,spin, length=2400){
  const data = new Float32Array(length);
  const Mc = Math.pow((m1*m2)**(3/5)/(m1+m2)**(1/5),1);
  const f0 = 20 + spin*15;
  const f1 = 400 + (Mc/30)*220;
  for(let i=0;i<length;i++){
    const t = i/(length-1);
    const env = Math.pow(t,1.8) * Math.exp(-1.2*(1-t));
    const freq = f0 + Math.pow(t,1.6) * (f1 - f0);
    data[i] = env * Math.sin(2*Math.PI * freq * (t*1.6));
  }
  return { samples: data, f0, f1, Mc };
}

/* -----------------------
   Panel helper constructor (A & B)
   ----------------------- */
function Panel(idPrefix, canvasOrbitId, canvasChirpId, controls) {
  this.id = idPrefix;
  this.orbitCanvas = document.getElementById(canvasOrbitId);
  this.orbitCtx = this.orbitCanvas.getContext('2d');
  this.chirpCanvas = document.getElementById(canvasChirpId);
  this.chirpCtx = this.chirpCanvas.getContext('2d');

  this.select = document.getElementById(controls.select);
  this.m1 = document.getElementById(controls.m1);
  this.m2 = document.getElementById(controls.m2);
  this.spin = document.getElementById(controls.spin);
  this.spinVal = document.getElementById(controls.spinVal);

  this.runBtn = document.getElementById(controls.run);
  this.resetBtn = document.getElementById(controls.reset);
  this.playBtn = document.getElementById(controls.play);
  this.stopBtn = document.getElementById(controls.stop);

  this.info = {
    name: document.getElementById(controls.name),
    cm: document.getElementById(controls.cm),
    fr: document.getElementById(controls.fr),
    h:  document.getElementById(controls.h),
    d:  document.getElementById(controls.d)
  };

  this.wave = null;
  this.animHandle = null;
  this.orbitState = { angle:0, trailsA:[], trailsB:[], running:false, startTime:0, duration:2500 };
  this.audio = { ctx:null, osc:null, oscHarm:null, gain:null, gainHarm:null, playing:false, playStart:0, playDur:0, raf:null };
  this.accent = '#a64dff';
}

/* Panel methods */
Panel.prototype.updateSpinLabel = function(){ this.spinVal.textContent = Number(this.spin.value).toFixed(2); };

Panel.prototype.drawOrbitFrame = function(m1,m2,spin,color){
  // Simple circling visual with trails (non-blocking)
  const ctx = this.orbitCtx;
  const W = this.orbitCanvas.width, H = this.orbitCanvas.height;
  ctx.clearRect(0,0,W,H);
  const cx = W/2, cy = H/2;
  const a = this.orbitState.angle;
  const rA = 70 + 0; const rB = 140 + 0;
  const xA = cx + Math.cos(a) * rA, yA = cy + Math.sin(a) * rA;
  const xB = cx - Math.cos(a) * rB, yB = cy - Math.sin(a) * rB;

  // background
  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, 'rgba(6,0,16,0.9)'); g.addColorStop(1,'rgba(0,0,0,1)');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

  // push trails
  this.orbitState.trailsA.push({x:xA,y:yA}); this.orbitState.trailsB.push({x:xB,y:yB});
  if(this.orbitState.trailsA.length>140) this.orbitState.trailsA.shift();
  if(this.orbitState.trailsB.length>140) this.orbitState.trailsB.shift();

  for(let i=0;i<this.orbitState.trailsA.length;i++){
    const p = this.orbitState.trailsA[i];
    const alpha = (i/this.orbitState.trailsA.length)*0.16;
    ctx.fillStyle = hexToRgba(color, alpha);
    ctx.fillRect(p.x-1, p.y-1, 3, 3);
  }
  for(let i=0;i<this.orbitState.trailsB.length;i++){
    const p = this.orbitState.trailsB[i];
    const alpha = (i/this.orbitState.trailsB.length)*0.16;
    ctx.fillStyle = hexToRgba(shadeColor(color,-15), alpha);
    ctx.fillRect(p.x-2, p.y-2, 4, 4);
  }

  // bodies
  ctx.beginPath(); ctx.arc(xA,yA,10,0,Math.PI*2); ctx.fillStyle=color; ctx.fill();
  ctx.beginPath(); ctx.arc(xB,yB,16,0,Math.PI*2); ctx.fillStyle=shadeColor(color,-20); ctx.fill();

  // small orbital flicker
  ctx.beginPath(); ctx.arc(cx + Math.cos(a*1.3 + spin) * (rA*1.06), cy + Math.sin(a*1.3 + spin) * (rA*0.56), 3, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(255,220,180,0.7)'; ctx.fill();

  this.orbitState.angle += 0.02 + spin*0.02;
};

Panel.prototype.startOrbit = function(m1,m2,spin,color){
  if(this.animHandle) cancelAnimationFrame(this.animHandle);
  this.orbitState.trailsA=[]; this.orbitState.trailsB=[];
  this.orbitState.angle = 0;
  this.orbitState.running = true;
  const self = this;
  function step(){
    self.drawOrbitFrame(m1,m2,spin,color);
    if(self.orbitState.running) self.animHandle = requestAnimationFrame(step);
  }
  step();
};

Panel.prototype.stopOrbit = function(){ this.orbitState.running = false; if(this.animHandle) cancelAnimationFrame(this.animHandle); };

Panel.prototype.drawChirp = function(playIdx=-1){
  const ctx = this.chirpCtx;
  const W = this.chirpCanvas.width, H = this.chirpCanvas.height;
  ctx.clearRect(0,0,W,H);
  if(!this.wave) return;
  const samples = this.wave.samples;
  ctx.beginPath();
  for(let i=0;i<samples.length;i++){
    const x = i/samples.length * W;
    const y = H/2 - samples[i] * (H/2) * 0.9;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.strokeStyle = this.accent; ctx.lineWidth = 1.6; ctx.stroke();
  if(playIdx >= 0){
    const px = playIdx / samples.length * W;
    ctx.beginPath(); ctx.moveTo(px,0); ctx.lineTo(px,H);
    ctx.strokeStyle='rgba(255,100,100,0.95)'; ctx.lineWidth=1.2; ctx.stroke();
  }
};

Panel.prototype.generateAndDisplay = function(name,m1,m2,spin,color){
  this.accent = color;
  this.wave = generateWaveform(m1,m2,spin, 2200);
  this.drawChirp(-1);
  // update info table
  this.info.name.textContent = name;
  this.info.cm.textContent = this.wave.Mc.toFixed(2) + ' M‚òâ';
  this.info.fr.textContent = `${Math.round(this.wave.f0)}‚Äì${Math.round(this.wave.f1)} Hz`;
  this.info.h.textContent = (4e-21 * Math.pow(this.wave.Mc/30,5/3)).toExponential(2);
  this.info.d.textContent = `${Math.round(this.wave.Mc*40)} million ly`; // toy mapping
};

Panel.prototype.playAudio = async function(){
  if(!this.wave) return;
  if(!this.audio.ctx) this.audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
  if(this.audio.ctx.state === 'suspended') await this.audio.ctx.resume().catch(()=>{});
  // stop any previous
  this.stopAudio();

  const Mc = this.wave.Mc;
  const fStart = this.wave.f0;
  const fEnd = this.wave.f1;
  const duration = Math.max(0.9, 3.0 - (Mc/60));
  this.audio.playDur = duration * 1000;

  this.audio.osc = this.audio.ctx.createOscillator();
  this.audio.gain = this.audio.ctx.createGain();
  this.audio.osc.type = 'sine';
  this.audio.osc.connect(this.audio.gain); this.audio.gain.connect(this.audio.ctx.destination);

  this.audio.oscHarm = this.audio.ctx.createOscillator();
  this.audio.gainHarm = this.audio.audioGainHarm || this.audio.ctx.createGain();
  this.audio.oscHarm.type = 'sine';
  this.audio.oscHarm.connect(this.audio.gainHarm); this.audio.gainHarm.connect(this.audio.ctx.destination);

  const now = this.audio.ctx.currentTime;
  this.audio.osc.frequency.setValueAtTime(Math.max(1,fStart), now);
  this.audio.osc.frequency.exponentialRampToValueAtTime(Math.max(2,fEnd), now + duration);

  this.audio.oscHarm.frequency.setValueAtTime(Math.max(2,fStart*2), now);
  this.audio.oscHarm.frequency.exponentialRampToValueAtTime(Math.max(2,fEnd*2), now + duration);

  this.audio.gain.gain.setValueAtTime(0.0001, now);
  this.audio.gain.gain.linearRampToValueAtTime(0.26, now + 0.02);
  this.audio.gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  this.audio.gainHarm.gain.setValueAtTime(0.0001, now);
  this.audio.gainHarm.gain.linearRampToValueAtTime(0.05, now + 0.02);
  this.audio.gainHarm.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  this.audio.osc.start(now); this.audio.osc.stop(now + duration + 0.05);
  this.audio.oscHarm.start(now); this.audio.oscHarm.stop(now + duration + 0.05);

  // visuals sync
  this.audio.playStart = performance.now();
  const self = this;
  function rafStep(){
    const elapsed = performance.now() - self.audio.playStart;
    if(elapsed >= self.audio.playDur){
      self.stopAudio();
      return;
    }
    const prog = elapsed / self.audio.playDur;
    const idx = Math.floor(prog * self.wave.samples.length);
    self.drawChirp(idx);
    self.drawSmallPulse(prog);
    self.audio.raf = requestAnimationFrame(rafStep);
  }
  this.audio.raf = requestAnimationFrame(rafStep);
  this.audio.playing = true;
};

Panel.prototype.drawSmallPulse = function(progress){
  // subtle pulse overlay on chirp canvas (already used)
  const ctx = this.chirpCtx;
  const W = this.chirpCanvas.width, H = this.chirpCanvas.height;
  const centerX = progress * W;
  const width = Math.max(6, 0.04 * W * (0.4 + progress));
  const g = ctx.createLinearGradient(centerX - width, 0, centerX + width, 0);
  g.addColorStop(0, 'rgba(0,0,0,0)');
  g.addColorStop(0.35, hexToRgba(this.accent, 0.18));
  g.addColorStop(0.65, hexToRgba(this.accent, 0.18));
  g.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g; ctx.fillRect(centerX - width, 0, width*2, H);
};

Panel.prototype.stopAudio = function(){
  try{ if(this.audio.osc) this.audio.osc.stop(); }catch(e){}
  try{ if(this.audio.oscHarm) this.audio.oscHarm.stop(); }catch(e){}
  try{ if(this.audio.gain) this.audio.gain.disconnect(); }catch(e){}
  try{ if(this.audio.gainHarm) this.audio.gainHarm.disconnect(); }catch(e){}
  try{ if(this.audio.osc) this.audio.osc.disconnect(); }catch(e){}
  try{ if(this.audio.oscHarm) this.audio.oscHarm.disconnect(); }catch(e){}
  if(this.audio.raf){ cancelAnimationFrame(this.audio.raf); this.audio.raf = null; }
  this.audio.playing = false;
  this.drawChirp(-1);
};

/* -----------------------
   Instantiate panels A & B and wire UI
   ----------------------- */
const panelA = new Panel('A','orbitA','chirpA',{
  select:'eventA', m1:'m1A', m2:'m2A', spin:'spinA', spinVal:'spinValA',
  run:'runA', reset:'resetA', play:'playA', stop:'stopA',
  name:'nameA', cm:'cmA', fr:'frA', h:'hA', d:'dA'
});
const panelB = new Panel('B','orbitB','chirpB',{
  select:'eventB', m1:'m1B', m2:'m2B', spin:'spinB', spinVal:'spinValB',
  run:'runB', reset:'resetB', play:'playB', stop:'stopB',
  name:'nameB', cm:'cmB', fr:'frB', h:'hB', d:'dB'
});

/* Set default UI values from EVENTS and add listeners */
function applyEventToPanel(panel, key){
  const ev = EVENTS[key] || EVENTS.Custom;
  panel.select.value = key;
  panel.m1.value = ev.m1; panel.m2.value = ev.m2; panel.spin.value = ev.spin; panel.updateSpinLabel();
  panel.generateAndDisplay(key, ev.m1, ev.m2, ev.spin, ev.color);
  panel.startOrbit(ev.m1, ev.m2, ev.spin, ev.color);
}

/* initial load A & B */
applyEventToPanel(panelA, 'GW150914');
applyEventToPanel(panelB, 'GW170104');

/* selection change handlers */
panelA.select.addEventListener('change', ()=> applyEventToPanel(panelA, panelA.select.value));
panelB.select.addEventListener('change', ()=> applyEventToPanel(panelB, panelB.select.value));

/* spin label */
panelA.spin.addEventListener('input', ()=> panelA.updateSpinLabel());
panelB.spin.addEventListener('input', ()=> panelB.updateSpinLabel());

/* Run (start inspiral toy) ‚Äî here we simply accelerate the orbit and shrink trails (toy) */
panelA.runBtn.addEventListener('click', ()=>{
  const m1 = clamp(parseFloat(panelA.m1.value)||30,1,1e6);
  const m2 = clamp(parseFloat(panelA.m2.value)||30,1,1e6);
  const spin = clamp(parseFloat(panelA.spin.value)||0.5,0,1);
  const color = (EVENTS[panelA.select.value]||EVENTS.Custom).color || '#a64dff';
  // update event record if custom changed
  EVENTS.Custom = { m1,m2,spin,color, desc:`Custom: ${m1}+${m2} M‚òâ` };
  panelA.generateAndDisplay('Custom', m1,m2,spin,color);
  panelA.startOrbit(m1,m2,spin,color);
});
panelB.runBtn.addEventListener('click', ()=>{
  const m1 = clamp(parseFloat(panelB.m1.value)||30,1,1e6);
  const m2 = clamp(parseFloat(panelB.m2.value)||30,1,1e6);
  const spin = clamp(parseFloat(panelB.spin.value)||0.5,0,1);
  const color = (EVENTS[panelB.select.value]||EVENTS.Custom).color || '#ffd166';
  EVENTS.Custom = { m1,m2,spin,color, desc:`Custom: ${m1}+${m2} M‚òâ` };
  panelB.generateAndDisplay('Custom', m1,m2,spin,color);
  panelB.startOrbit(m1,m2,spin,color);
});

/* Reset */
panelA.resetBtn.addEventListener('click', ()=> applyEventToPanel(panelA, panelA.select.value));
panelB.resetBtn.addEventListener('click', ()=> applyEventToPanel(panelB, panelB.select.value));

/* Play / Stop audio per panel */
panelA.playBtn.addEventListener('click', async ()=>{
  panelA.playAudio();
});
panelA.stopBtn.addEventListener('click', ()=> panelA.stopAudio());

panelB.playBtn.addEventListener('click', async ()=>{
  panelB.playAudio();
});
panelB.stopBtn.addEventListener('click', ()=> panelB.stopAudio());

/* Export combined amplitude summary for both (draw both wave envelopes) */
function drawAmpBoth(){
  const ctx = document.getElementById('ampBoth').getContext('2d');
  const W = 920, H = 110;
  ctx.clearRect(0,0,W,H);
  // A
  if(panelA.wave){
    ctx.beginPath();
    const samples = panelA.wave.samples;
    for(let i=0;i<W;i++){
      const t = i/W;
      const v = Math.abs(samples[Math.floor(t*samples.length)] || 0);
      const y = H - v*(H*0.9);
      if(i===0) ctx.moveTo(i,y); else ctx.lineTo(i,y);
    }
    ctx.strokeStyle = panelA.accent; ctx.lineWidth = 2; ctx.stroke();
  }
  // B
  if(panelB.wave){
    ctx.beginPath();
    const samples = panelB.wave.samples;
    for(let i=0;i<W;i++){
      const t = i/W;
      const v = Math.abs(samples[Math.floor(t*samples.length)] || 0);
      const y = H - v*(H*0.9);
      if(i===0) ctx.moveTo(i,y); else ctx.lineTo(i,y);
    }
    ctx.strokeStyle = panelB.accent; ctx.lineWidth = 2; ctx.stroke();
  }
}

/* update both amplitude view periodically */
setInterval(drawAmpBoth, 800);

/* export button (top of events) to export both A+B params+samples */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const pA = panelA.wave ? panelA.wave : generateWaveform(parseFloat(panelA.m1.value), parseFloat(panelA.m2.value), parseFloat(panelA.spin.value));
  const pB = panelB.wave ? panelB.wave : generateWaveform(parseFloat(panelB.m1.value), parseFloat(panelB.m2.value), parseFloat(panelB.spin.value));
  const payload = {
    A: { params: {m1: panelA.m1.value, m2: panelA.m2.value, spin: panelA.spin.value}, samples: Array.from(pA.samples).slice(0,1000) },
    B: { params: {m1: panelB.m1.value, m2: panelB.m2.value, spin: panelB.spin.value}, samples: Array.from(pB.samples).slice(0,1000) },
    generated: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `compare_AB_waveforms.json`; a.click();
  URL.revokeObjectURL(url);
});

/* utility helpers */
function hexToRgba(hex, alpha=1.0){
  if(!hex) return `rgba(200,200,200,${alpha})`;
  if(hex.startsWith('rgba') || hex.startsWith('rgb')) {
    const nums = hex.replace(/rgba?|\(|\)|\s/g,'').split(',').map(Number);
    return `rgba(${nums[0]},${nums[1]},${nums[2]},${alpha})`;
  }
  const h = hex.replace('#','');
  const r = parseInt(h.substring(0,2),16), g = parseInt(h.substring(2,4),16), b = parseInt(h.substring(4,6),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function shadeColor(hex, percent){
  if(!hex.startsWith('#')) return hex;
  const h = hex.replace('#','');
  const r = clamp(parseInt(h.substring(0,2),16) + Math.round(2.55*percent),0,255);
  const g = clamp(parseInt(h.substring(2,4),16) + Math.round(2.55*percent),0,255);
  const b = clamp(parseInt(h.substring(4,6),16) + Math.round(2.55*percent),0,255);
  return `rgb(${r},${g},${b})`;
}
function clamp(x,a,b){ return Math.max(a,Math.min(b,x)); }

</script>
</body>
</html>
