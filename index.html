<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Open BBH Visualizer ‚Äî 3D Orbit + Chirp</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
  :root{
    --bg:#04040a; --panel:#0c0c14; --accent:#00d0ff; --accent2:#ff2e8a; --muted:#9aa;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#030316 0%, #000 100%);color:#eaeef6;font-family:system-ui, -apple-system, "Segoe UI";}
  header{padding:14px 12px;text-align:center;background:rgba(255,255,255,0.02);position:sticky;top:0;z-index:30}
  header h1{margin:0;font-size:1.2rem;color:var(--accent)}
  .top-controls{display:flex;gap:8px;justify-content:center;align-items:center;padding:10px;flex-wrap:wrap}
  select,input[type=number],button{background:var(--panel);color:#e9f6ff;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px}
  button{cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;max-width:1200px;margin:0 auto}
  @media(min-width:1000px){ .grid{grid-template-columns:1fr 420px} }
  .panel{background:transparent;padding:8px;border-radius:8px}
  #wavePanel{position:relative}
  #progressBar{position:absolute;left:6px;right:6px;top:8px;height:6px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;z-index:15}
  #progressFill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 0 8px rgba(0,208,255,0.18)}
  #mainPlot,#specPlot,#orbitPlot{background:var(--panel);border-radius:8px}
  .right-column{display:flex;flex-direction:column;gap:12px}
  .controls-block{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
  .small{font-size:0.9rem;color:var(--muted)}
  /* auto-hide player at bottom center */
  #player{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:18px;background:rgba(4,4,10,0.88);padding:8px 12px;border-radius:999px;
    border:1px solid rgba(255,255,255,0.04);display:flex;gap:10px;align-items:center;z-index:60;transition:opacity .35s,transform .35s;
  }
  #player.hidden{opacity:0;pointer-events:none;transform:translateX(-50%) translateY(30px)}
  #player button{background:transparent;border:none;color:#eaf6ff;font-size:18px}
  #player .prog{width:160px;height:6px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden}
  #player .prog > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 0 8px rgba(0,208,255,0.18)}
  #infoBtn{position:fixed;right:12px;top:12px;background:var(--panel);padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;z-index:70}
  #details{position:fixed;right:12px;top:56px;background:rgba(4,4,10,0.96);padding:12px;border-radius:8px;color:#dfeaff;border:1px solid rgba(255,255,255,0.03);display:none;z-index:70;min-width:220px}
  .btn-small{padding:6px 8px;border-radius:6px}
</style>
</head>
<body>

<header>
  <h1>Open BBH Visualizer ‚Äî 3D Orbit + Chirp</h1>
  <div class="top-controls">
    <select id="presetSelect" title="Choose event">
      <option value="GW150914">GW150914 (first BBH)</option>
      <option value="GW170104">GW170104</option>
      <option value="GW190521">GW190521</option>
      <option value="custom">Custom simulation</option>
    </select>

    <button id="openControls" class="btn-small">‚öôÔ∏è Controls</button>
    <button id="genBtn" class="btn-small">Generate</button>
  </div>
</header>

<div class="grid">
  <!-- left: waveform + spectrogram -->
  <div class="panel" id="wavePanel">
    <div id="progressBar"><div id="progressFill"></div></div>
    <div id="mainPlot" style="width:100%;height:360px;"></div>
    <div id="specPlot" style="width:100%;height:220px;margin-top:12px;"></div>
  </div>

  <!-- right column: orbit (3D) + custom controls -->
  <div class="right-column">
    <div class="panel" id="orbitPanel">
      <div id="orbitPlot" style="width:100%;height:420px;"></div>
    </div>

    <div class="controls-block" id="customBlock" aria-hidden="true">
      <div class="small">Custom initial parameters</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <label class="small">m‚ÇÅ (M‚òâ) <input id="m1" type="number" value="36" min="1" style="width:90px"></label>
        <label class="small">m‚ÇÇ (M‚òâ) <input id="m2" type="number" value="29" min="1" style="width:90px"></label>
        <label class="small">spin‚ÇÅ <input id="s1" type="number" value="0.3" min="0" max="0.99" step="0.01" style="width:80px"></label>
        <label class="small">spin‚ÇÇ <input id="s2" type="number" value="0.2" min="0" max="0.99" step="0.01" style="width:80px"></label>
        <label class="small">sep (M) <input id="sep" type="number" value="15" min="6" style="width:84px"></label>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="runCustom" class="btn-small">Run Custom</button>
        <button id="resetBtn" class="btn-small">Reset</button>
      </div>
    </div>
  </div>
</div>

<!-- player floating (auto-hide) -->
<div id="player" class="hidden" aria-label="player">
  <button id="playPause" title="Play / Pause">‚ñ∂Ô∏è</button>
  <button id="restart" title="Restart">üîÅ</button>
  <div class="prog"><i id="progFill"></i></div>
  <button id="soundToggle" title="Toggle sound">üîá</button>
</div>

<button id="infoBtn" title="View details">‚ÑπÔ∏è</button>
<div id="details" role="dialog" aria-hidden="true">
  <div style="font-weight:700;margin-bottom:6px">Current simulation</div>
  <div id="detailText" class="small"></div>
</div>

<script>
/* ============================
   Core: chirp generator + plots
   ============================ */

let state = {
  m1:36, m2:29, s1:0.3, s2:0.2, sep:15,
  duration:6.0, sampleRate:1024, playing:false,
  tIndex:0, audioEnabled:false, audioOsc:null, audioCtx:null,
  autoHideTimer:null
};

const mainDiv = document.getElementById('mainPlot');
const specDiv = document.getElementById('specPlot');
const orbitDiv = document.getElementById('orbitPlot');
const progressFill = document.getElementById('progressFill');
const progFillSmall = document.getElementById('progFill');
const player = document.getElementById('player');

function chirpParamsFromState(){
  return {m1:state.m1,m2:state.m2,s1:state.s1,s2:state.s2,sep:state.sep};
}

// produce time series with physically-inspired chirp (toy model)
function generateChirp(params){
  const {m1,m2,sep} = params;
  const total = m1 + m2;
  const chirpMass = Math.pow((m1*m2), 3/5) / Math.pow(total,1/5);
  const duration = Math.max(3, Math.min(12, 8 * Math.max(1, (30/chirpMass)) * 0.8)); // adapt duration by mass
  const sr = state.sampleRate;
  const N = Math.round(duration*sr);
  const t = new Array(N);
  const h = new Array(N);
  const freq = new Array(N);
  const f0 = 20 * Math.sqrt(30/chirpMass);
  const f1 = 800 * Math.sqrt(30/chirpMass);
  for(let i=0;i<N;i++){
    const tt = i/sr;
    t[i]=tt;
    // frequency ramps steeply toward merger:
    const tau = tt/duration;
    const fr = f0 + (f1-f0)*Math.pow(tau, 3.2);
    freq[i]=fr;
    const amp = Math.pow(tau,1.8)*Math.exp(-2.2*(1-tau));
    h[i] = amp * Math.sin(2*Math.PI*fr*tt);
  }
  return {t,h,freq,duration};
}

/* ----- Plot helpers ----- */

function plotWaveform(ts){
  const trace = { x: ts.t, y: ts.h, mode:'lines', line:{color:'#00d7ff'}, name:'h(t)' };
  const layout = { margin:{t:30,l:50,r:10,b:40}, paper_bgcolor:'transparent', plot_bgcolor:'transparent',
     xaxis:{title:'Time (s)'}, yaxis:{title:'Strain'} };
  Plotly.newPlot(mainDiv, [trace], layout, {displayModeBar:false,responsive:true});
}

function plotSpectrogram(ts){
  // short STFT-like heatmap: magnitude of local amplitude windows
  const w = 256, hop = 128;
  const mags = [];
  for(let i=0;i+ w < ts.h.length;i+=hop){
    const seg = ts.h.slice(i,i+w);
    const mag = new Array(w).fill(0);
    for(let k=0;k<w;k++) mag[k]=Math.abs(seg[k]);
    mags.push(mag);
  }
  const layout = {margin:{t:30,l:50,r:10,b:40},paper_bgcolor:'transparent',plot_bgcolor:'transparent',
    xaxis:{title:'Time window'}, yaxis:{title:'Frequency bin'}};
  Plotly.newPlot(specDiv, [{z:mags, x: Array.from({length:mags.length},(_,i)=>i), y: Array.from({length:w},(_,i)=>i), type:'heatmap', colorscale:'Viridis'}], layout, {displayModeBar:false,responsive:true});
}

/* ----- 3D Orbit (Plotly scatter3d) ----- */
function initOrbit3D(){
  // initial stationary placeholders
  const data = [
    { x:[0], y:[0], z:[0], mode:'markers', marker:{size:8,color:'#00d7ff'}, name:'BH1', type:'scatter3d' },
    { x:[0], y:[0], z:[0], mode:'markers', marker:{size:8,color:'#ff2e8a'}, name:'BH2', type:'scatter3d' },
    { x:[0,0,0,0], y:[0,0,0,0], z:[0,0,0,0], mode:'lines', line:{color:'#444',width:1}, showlegend:false, type:'scatter3d' }
  ];
  const layout = {
    margin:{t:30,b:10,l:30,r:10},
    scene:{aspectmode:'auto',camera:{eye:{x:1.4,y:1.2,z:0.8}},xaxis:{visible:false},yaxis:{visible:false},zaxis:{visible:false}},
    paper_bgcolor:'transparent',plot_bgcolor:'transparent'
  };
  Plotly.newPlot(orbitDiv,data,layout,{displayModeBar:false,responsive:true});
}
initOrbit3D();

function updateOrbit3D(frameIndex, ts, params){
  // simple top-down circular orbits with slight tilt for z
  const {m1,m2,sep} = params;
  const total = m1 + m2;
  const radius = sep * 0.6 * (1 - frameIndex/ts.t.length*0.65); // shrink towards merger
  const speedFactor = 0.015 * (1 + (m1+m2)/100); // heavier -> faster base
  const theta = frameIndex * speedFactor;
  const r1 = radius * (m2/total);
  const r2 = radius * (m1/total);
  const tilt = 0.35;
  const x1 = r1 * Math.cos(theta), y1 = r1 * Math.sin(theta), z1 = tilt * Math.sin(theta*0.6);
  const x2 = -r2 * Math.cos(theta), y2 = -r2 * Math.sin(theta), z2 = -tilt * Math.sin(theta*0.6);
  // orbit ring (coarse)
  const ringPts = 48;
  const ringX = [], ringY = [], ringZ = [];
  for(let i=0;i<=ringPts;i++){
    const th = i/ringPts*2*Math.PI;
    ringX.push(radius*Math.cos(th)); ringY.push(radius*Math.sin(th)); ringZ.push(tilt*Math.cos(th)*0.1);
  }
  // update traces
  Plotly.restyle(orbitDiv, {'x':[[x1]],[x2],[ringX]},{0,1,2});
  Plotly.restyle(orbitDiv, {'y':[[y1]],[y2],[ringY]},{0,1,2});
  Plotly.restyle(orbitDiv, {'z':[[z1]],[z2],[ringZ]},{0,1,2});
}

/* ===============
   Playback engine
   =============== */

let tsData = null;
let rafId = null;

function resetPlayback(){
  state.tIndex = 0;
  progressFill.style.width = '0%';
  progFillSmall.style.width = '0%';
  if(state.audioOsc){
    try{ state.audioOsc.stop(); }catch(e){}
    state.audioOsc=null;
  }
}

function play(){
  if(!tsData) return;
  if(state.tIndex >= tsData.t.length) state.tIndex = 0;
  state.playing = true;
  showPlayer();
  const sr = state.sampleRate;
  // create audio oscillator if enabled and permitted
  if(state.audioEnabled && !state.audioCtx){
    state.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  if(state.audioEnabled && state.audioCtx && !state.audioOsc){
    const osc = state.audioCtx.createOscillator();
    const gain = state.audioCtx.createGain();
    osc.type='sine';
    gain.gain.value = 0.05;
    osc.connect(gain); gain.connect(state.audioCtx.destination);
    osc.start();
    state.audioOsc = {osc,gain};
  }

  // step loop
  function step(){
    if(!state.playing){ rafId=null; return; }
    const i = state.tIndex;
    // update progress UI
    const frac = i / Math.max(1, tsData.t.length-1);
    const pct = Math.round(frac*10000)/100;
    progressFill.style.width = `${pct}%`;
    progFillSmall.style.width = `${pct}%`;
    // update waveform highlight via vertical line (Plotly shapes) ‚Äî simpler: skip heavy shapes
    // update orbit positions
    updateOrbitFrame(i);
    // update audio freq if active
    if(state.audioEnabled && state.audioOsc){
      // map physical freq to audible freq range (scale factor)
      const physFreq = tsData.freq[i] || 50;
      const audible = Math.min(1500, 80 + physFreq*1.2);
      try{ state.audioOsc.osc.frequency.setValueAtTime(audible, state.audioCtx.currentTime); }catch(e){}
    }
    state.tIndex++;
    if(state.tIndex < tsData.t.length){
      rafId = requestAnimationFrame(step);
    } else {
      state.playing = false;
      rafId = null;
    }
  }
  if(!rafId) rafId = requestAnimationFrame(step);
}

function pause(){
  state.playing = false;
  if(state.audioOsc){ try{ state.audioOsc.osc.frequency.cancelScheduledValues(state.audioCtx.currentTime); }catch(e){} }
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
}

function restart(){
  resetPlayback();
  play();
}

/* sync helper: update 3d orbit frame using tsData */
function updateOrbitFrame(frameIndex){
  if(!tsData) return;
  const params = chirpParamsFromState();
  // clamp index
  const idx = Math.min(frameIndex, tsData.t.length-1);
  // Use Plotly restyle with arrays for each trace update
  const {m1,m2,sep} = params;
  const total = m1 + m2;
  const radius = sep * 0.6 * (1 - idx/tsData.t.length*0.65);
  const speedFactor = 0.015 * (1 + (m1+m2)/100);
  const theta = idx * speedFactor;
  const r1 = radius * (m2/total);
  const r2 = radius * (m1/total);
  const tilt = 0.35;
  const x1 = r1 * Math.cos(theta), y1 = r1 * Math.sin(theta), z1 = tilt * Math.sin(theta*0.6);
  const x2 = -r2 * Math.cos(theta), y2 = -r2 * Math.sin(theta), z2 = -tilt * Math.sin(theta*0.6);
  // ring
  const ringPts = 48, ringX=[], ringY=[], ringZ=[];
  for(let i=0;i<=ringPts;i++){
    const th = i/ringPts*2*Math.PI;
    ringX.push(radius*Math.cos(th)); ringY.push(radius*Math.sin(th)); ringZ.push(tilt*Math.cos(th)*0.1);
  }
  // stash arrays - Plotly.restyle accepts array-of-arrays
  Plotly.restyle(orbitDiv, {'x':[[x1],[x2],ringX], 'y':[[y1],[y2],ringY], 'z':[[z1],[z2],ringZ]}, [0,1,2]);
}

/* ====================
   UI wiring & actions
   ==================== */

function showPlayer(){
  player.classList.remove('hidden');
  // reset auto-hide
  if(state.autoHideTimer) clearTimeout(state.autoHideTimer);
  state.autoHideTimer = setTimeout(()=>{ player.classList.add('hidden'); }, 3000);
}

// show controls panel
document.getElementById('openControls').addEventListener('click', ()=>{
  const cb = document.getElementById('customBlock');
  const vis = cb.getAttribute('aria-hidden') === 'false';
  cb.style.display = vis ? 'none' : 'block';
  cb.setAttribute('aria-hidden', String(vis));
});

// preset selection handling
document.getElementById('presetSelect').addEventListener('change', (e)=>{
  const v = e.target.value;
  if(v==='custom'){
    document.getElementById('customBlock').style.display='block';
    document.getElementById('customBlock').setAttribute('aria-hidden','false');
    return;
  }
  document.getElementById('customBlock').style.display='none';
  const presets = {
    'GW150914':{m1:36,m2:29,s1:0.3,s2:0.2,sep:15},
    'GW170104':{m1:31,m2:19,s1:0.1,s2:0.05,sep:14},
    'GW190521':{m1:85,m2:66,s1:0.7,s2:0.6,sep:20}
  };
  const p = presets[v] || presets['GW150914'];
  state.m1=p.m1; state.m2=p.m2; state.s1=p.s1; state.s2=p.s2; state.sep=p.sep;
  generateAndPlot();
});

// generate button
document.getElementById('genBtn').addEventListener('click', generateAndPlot);
document.getElementById('runCustom').addEventListener('click', ()=>{
  state.m1 = Number(document.getElementById('m1').value);
  state.m2 = Number(document.getElementById('m2').value);
  state.s1 = Number(document.getElementById('s1').value);
  state.s2 = Number(document.getElementById('s2').value);
  state.sep = Number(document.getElementById('sep').value);
  generateAndPlot();
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.getElementById('m1').value=36; document.getElementById('m2').value=29; document.getElementById('s1').value=0.3; document.getElementById('s2').value=0.2; document.getElementById('sep').value=15;
  state.m1=36; state.m2=29; state.s1=0.3; state.s2=0.2; state.sep=15;
  generateAndPlot();
});

// player controls
document.getElementById('playPause').addEventListener('click', ()=>{
  if(state.playing){ pause(); document.getElementById('playPause').textContent='‚ñ∂Ô∏è'; }
  else { play(); document.getElementById('playPause').textContent='‚è∏'; showPlayer(); }
});
document.getElementById('restart').addEventListener('click', ()=>{ resetPlayback(); play(); document.getElementById('playPause').textContent='‚è∏'; showPlayer(); });
document.getElementById('soundToggle').addEventListener('click', ()=>{
  state.audioEnabled = !state.audioEnabled;
  if(!state.audioEnabled && state.audioOsc){ try{ state.audioOsc.osc.stop(); }catch(e){} state.audioOsc=null; }
  document.getElementById('soundToggle').textContent = state.audioEnabled ? 'üîä' : 'üîá';
  // user gesture: create AudioContext when enabling
  if(state.audioEnabled && !state.audioCtx){ state.audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  showPlayer();
});

// info/details
const infoBtn = document.getElementById('infoBtn');
const details = document.getElementById('details');
const detailText = document.getElementById('detailText');
infoBtn.addEventListener('click', ()=> {
  if(details.style.display === 'block'){ details.style.display='none'; details.setAttribute('aria-hidden','true'); return; }
  // populate details
  detailText.innerHTML = `m‚ÇÅ=${state.m1} M‚òâ<br>m‚ÇÇ=${state.m2} M‚òâ<br>spin‚ÇÅ=${state.s1}<br>spin‚ÇÇ=${state.s2}<br>sep=${state.sep} M`;
  details.style.display='block'; details.setAttribute('aria-hidden','false');
});

/* show player on any user interaction for discoverability */
['mousemove','touchstart','touchend','click'].forEach(evt=>{
  window.addEventListener(evt, ()=>{ player.classList.remove('hidden'); if(state.autoHideTimer) clearTimeout(state.autoHideTimer); state.autoHideTimer=setTimeout(()=>player.classList.add('hidden'),3000); }, {passive:true});
});

/* generate and plot */
function generateAndPlot(){
  // reset playback/audio
  pause(); resetPlayback();
  const p = chirpParamsFromState();
  tsData = generateChirp(p);
  // store tsData globally for playback
  plotWaveform(tsData);
  plotSpectrogram(tsData);
  // initial orbit states
  updateOrbitFrame(0);
  // update details
  detailText && (detailText.innerHTML = `m‚ÇÅ=${state.m1} M‚òâ<br>m‚ÇÇ=${state.m2} M‚òâ<br>spin‚ÇÅ=${state.s1}<br>spin‚ÇÇ=${state.s2}<br>sep=${state.sep} M`);
  // also reset small progress
  progressFill.style.width='0%'; progFillSmall.style.width='0%';
}

/* initial load */
generateAndPlot();

/* fallback: pause on page hide */
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) pause(); });

</script>
</body>
</html>
