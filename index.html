<script>
/* ============================================================
 Visualizer Fix — ensure all initial plots render correctly
 ============================================================ */

/* ---- small utilities ---- */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function linspace(a,b,n){const out=[]; for(let i=0;i<n;i++) out.push(a+(b-a)*i/(n-1)); return out;}

/* ---- chirp generator ---- */
function chirp(p){
  const m1=p.m1,m2=p.m2;const total=Math.max(1,m1+m2);
  const chirpMass=Math.pow((m1*m2),3/5)/Math.pow(total,1/5);
  const dur=clamp(5*(30/Math.max(1,chirpMass)),2,10);
  const sr=512; const N=Math.round(dur*sr);
  const t=[],h=[],f=[];
  const f0=20*Math.sqrt(30/Math.max(1,chirpMass));
  const f1=600*Math.sqrt(30/Math.max(1,chirpMass));
  for(let i=0;i<N;i++){
    const tt=i/sr; const tau=tt/dur;
    const fr=f0+(f1-f0)*Math.pow(tau,3); f.push(fr); t.push(tt);
    const amp=Math.pow(tau,1.7)*Math.exp(-2*(1-tau)); h.push(amp*Math.sin(2*Math.PI*fr*tt));
  }
  return {t,h,f,duration:dur};
}

/* ---- initial data ---- */
const params={m1:36,m2:29,sep:15};
const ts=chirp(params);

/* ---- plot creation ---- */
function plotAll(){
  Plotly.newPlot("presetWave",
    [{x:ts.t,y:ts.h,mode:'lines',line:{color:'#fff'}}],
    {title:'GW150914 — waveform',paper_bgcolor:'transparent',plot_bgcolor:'transparent'},
    {displayModeBar:false});
  Plotly.newPlot("presetSpec",
    [{z:[ts.h],type:'heatmap',colorscale:'Viridis'}],
    {title:'GW150914 — spectrogram',paper_bgcolor:'transparent',plot_bgcolor:'transparent'},
    {displayModeBar:false});
  Plotly.newPlot("energyPlot",
    [{x:ts.t,y:ts.h.map(v=>v*v),mode:'lines',line:{color:'#ffb86b'}}],
    {title:'Energy (toy)',paper_bgcolor:'transparent',plot_bgcolor:'transparent'},
    {displayModeBar:false});
  Plotly.newPlot("orbit3d",
    [
      {x:[0.2],y:[0],z:[0],mode:'markers',marker:{size:12,color:'orange'},type:'scatter3d'},
      {x:[-0.2],y:[0],z:[0],mode:'markers',marker:{size:10,color:'cyan'},type:'scatter3d'}
    ],
    {scene:{xaxis:{visible:false},yaxis:{visible:false},zaxis:{visible:false}},paper_bgcolor:'transparent'},
    {displayModeBar:false});
}
plotAll();

/* ---- ensure resize works ---- */
window.addEventListener('resize',()=>{["presetWave","presetSpec","orbit3d","energyPlot"].forEach(id=>{const el=document.getElementById(id);if(el)Plotly.Plots.resize(el);});});
</script>
