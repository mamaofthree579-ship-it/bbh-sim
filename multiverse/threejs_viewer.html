<!-- threejs_viewer.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Three.js Snapshot Viewer</title>
  <style> body { margin:0; background:#000 } #ui { position:absolute; z-index:10; padding:10px; color:#fff; } </style>
</head>
<body>
<div id="ui">
  <input id="fileInput" type="file" accept=".json" />
  <span id="status">Load a snapshot JSON to visualize.</span>
</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
let scene, camera, renderer;
function init() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.z = 120;
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);
}
init();

function clearScene() {
  while(scene.children.length>0) {
    scene.remove(scene.children[0]);
  }
}

// draw DM grid as plane texture (simple dots)
function drawDMGrid(dm) {
  const size = dm.length;
  const canvas = document.createElement('canvas');
  canvas.width = size; canvas.height = size;
  const ctx = canvas.getContext('2d');
  const img = ctx.createImageData(size, size);
  for (let y=0; y<size; y++){
    for (let x=0; x<size; x++){
      const v = Math.min(1, Math.max(0, dm[y][x]));
      const idx = (y*size + x)*4;
      // colormap: magma-like (simple purple->yellow)
      const r = Math.floor(255 * v);
      const g = Math.floor(60 * v);
      const b = Math.floor(120 * (1-v));
      img.data[idx] = r; img.data[idx+1]=g; img.data[idx+2]=b; img.data[idx+3]=200;
    }
  }
  ctx.putImageData(img,0,0);
  const tex = new THREE.CanvasTexture(canvas);
  const geo = new THREE.PlaneGeometry(90,90);
  const mat = new THREE.MeshBasicMaterial({map:tex, transparent:true, opacity:0.7});
  const plane = new THREE.Mesh(geo, mat);
  plane.position.set(0,0,-10);
  scene.add(plane);
}

let nodeMeshes = [];
function drawNodes(pos, amps, phases) {
  const N = pos.length;
  nodeMeshes = [];
  for (let i=0;i<N;i++){
    const amp = amps[i];
    const geometry = new THREE.SphereGeometry(1.5+amp*3, 12, 12);
    const h = (phases[i]+Math.PI)/(2*Math.PI);
    const color = new THREE.Color().setHSL(h, 1, 0.5);
    const mat = new THREE.MeshStandardMaterial({color: color});
    const mesh = new THREE.Mesh(geometry, mat);
    mesh.position.x = pos[i][0];
    mesh.position.y = pos[i][1];
    scene.add(mesh);
    nodeMeshes.push(mesh);
  }
  // add simple light
  const amb = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff, 0.6);
  dir.position.set(50,50,100); scene.add(dir);
}

function animate() {
  requestAnimationFrame(animate);
  // small rotation
  scene.rotation.z += 0.0005;
  renderer.render(scene, camera);
}
animate();

document.getElementById('fileInput').addEventListener('change', (ev)=>{
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const snap = JSON.parse(e.target.result);
      clearScene();
      drawDMGrid(snap.dm_grid);
      drawNodes(snap.pos, snap.node_amp, snap.node_phase);
      document.getElementById('status').textContent = `Loaded t=${snap.time}`;
    } catch(err) {
      document.getElementById('status').textContent = 'Error parsing JSON';
      console.error(err);
    }
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
